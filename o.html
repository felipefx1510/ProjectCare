<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>o</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      border: none;
      border-top: 1px solid #1a1a1a;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        background-color: #232629;
        color: #7a7c7d;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
    div.sourceCode
      { color: #cfcfc2; background-color: #232629; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #cfcfc2; } /* Normal */
    code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } /* Alert */
    code span.an { color: #3f8058; } /* Annotation */
    code span.at { color: #2980b9; } /* Attribute */
    code span.bn { color: #f67400; } /* BaseN */
    code span.bu { color: #7f8c8d; } /* BuiltIn */
    code span.cf { color: #fdbc4b; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #3daee9; } /* Char */
    code span.cn { color: #27aeae; font-weight: bold; } /* Constant */
    code span.co { color: #7a7c7d; } /* Comment */
    code span.cv { color: #7f8c8d; } /* CommentVar */
    code span.do { color: #a43340; } /* Documentation */
    code span.dt { color: #2980b9; } /* DataType */
    code span.dv { color: #f67400; } /* DecVal */
    code span.er { color: #da4453; text-decoration: underline; } /* Error */
    code span.ex { color: #0099ff; font-weight: bold; } /* Extension */
    code span.fl { color: #f67400; } /* Float */
    code span.fu { color: #8e44ad; } /* Function */
    code span.im { color: #27ae60; } /* Import */
    code span.in { color: #c45b00; } /* Information */
    code span.kw { color: #cfcfc2; font-weight: bold; } /* Keyword */
    code span.op { color: #cfcfc2; } /* Operator */
    code span.ot { color: #27ae60; } /* Other */
    code span.pp { color: #27ae60; } /* Preprocessor */
    code span.re { color: #2980b9; background-color: #153042; } /* RegionMarker */
    code span.sc { color: #3daee9; } /* SpecialChar */
    code span.ss { color: #da4453; } /* SpecialString */
    code span.st { color: #f44f4f; } /* String */
    code span.va { color: #27aeae; } /* Variable */
    code span.vs { color: #da4453; } /* VerbatimString */
    code span.wa { color: #da4453; } /* Warning */
  </style>
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#análise-detalhada-do-projeto-projectcare"
id="toc-análise-detalhada-do-projeto-projectcare"><strong>Análise
Detalhada do Projeto ProjectCare</strong></a>
<ul>
<li><a href="#sumário"
id="toc-sumário"><strong>Sumário</strong></a></li>
<li><a href="#introdução" id="toc-introdução"><strong>1.
Introdução</strong></a></li>
<li><a href="#visão-geral-do-projeto"
id="toc-visão-geral-do-projeto"><strong>2. Visão Geral do
Projeto</strong></a>
<ul>
<li><a href="#propósito-e-funcionalidades"
id="toc-propósito-e-funcionalidades">2.1. Propósito e
Funcionalidades</a></li>
<li><a href="#público-alvo" id="toc-público-alvo">2.2.
Público-Alvo</a></li>
<li><a href="#principais-tecnologias"
id="toc-principais-tecnologias">3.1. Principais Tecnologias</a></li>
<li><a href="#fluxo-de-uma-requisição-http"
id="toc-fluxo-de-uma-requisição-http">3.3. Fluxo de uma Requisição
HTTP</a></li>
<li><a href="#pré-requisitos"
id="toc-pré-requisitos"><strong>Pré-requisitos:</strong></a></li>
<li><a href="#instalação"
id="toc-instalação"><strong>Instalação:</strong></a></li>
<li><a href="#configuração-do-banco-de-dados"
id="toc-configuração-do-banco-de-dados"><strong>Configuração do Banco de
Dados:</strong></a></li>
<li><a href="#executando-a-aplicação"
id="toc-executando-a-aplicação"><strong>Executando a
Aplicação:</strong></a></li>
</ul></li>
<li><a href="#análise-detalhada-do-código"
id="toc-análise-detalhada-do-código"><strong>5. Análise Detalhada do
Código</strong></a>
<ul>
<li><a href="#ponto-de-entrada-da-aplicação-apprun.py-e-appinit.py"
id="toc-ponto-de-entrada-da-aplicação-apprun.py-e-appinit.py">5.1. Ponto
de Entrada da Aplicação (app/run.py e
app/<strong>init</strong>.py)</a></li>
<li><a href="#rotas-e-controladores-approutes"
id="toc-rotas-e-controladores-approutes">5.3. Rotas e Controladores
(app/routes/)</a></li>
<li><a href="#camada-de-serviço-appservices"
id="toc-camada-de-serviço-appservices"><strong>5.4. Camada de Serviço
(app/services/)</strong></a></li>
<li><a href="#arquivos-estáticos-appstatic"
id="toc-arquivos-estáticos-appstatic"><strong>5.6. Arquivos Estáticos
(app/static/)</strong></a></li>
<li><a href="#migrações-migrations"
id="toc-migrações-migrations"><strong>5.7. Migrações
(migrations/)</strong></a></li>
<li><a href="#arquivos-raiz" id="toc-arquivos-raiz"><strong>5.8.
Arquivos Raiz</strong></a></li>
</ul></li>
<li><a href="#autenticação-e-gerenciamento-de-sessão"
id="toc-autenticação-e-gerenciamento-de-sessão"><strong>6. Autenticação
e Gerenciamento de Sessão</strong></a>
<ul>
<li><a href="#autenticação-1" id="toc-autenticação-1"><strong>6.1.
Autenticação</strong></a></li>
<li><a href="#segurança-de-senhas-1"
id="toc-segurança-de-senhas-1"><strong>6.2. Segurança de
Senhas</strong></a></li>
<li><a href="#gerenciamento-de-sessão"
id="toc-gerenciamento-de-sessão"><strong>6.3. Gerenciamento de
Sessão</strong></a></li>
</ul></li>
<li><a href="#interface-do-usuário-frontend"
id="toc-interface-do-usuário-frontend"><strong>7. Interface do Usuário
(Frontend)</strong></a>
<ul>
<li><a href="#estrutura-de-templates"
id="toc-estrutura-de-templates"><strong>7.1. Estrutura de
Templates</strong></a></li>
<li><a href="#tecnologias-frontend"
id="toc-tecnologias-frontend"><strong>7.2. Tecnologias
Frontend</strong></a></li>
</ul></li>
<li><a href="#fluxos-de-usuário-chave"
id="toc-fluxos-de-usuário-chave"><strong>8. Fluxos de Usuário
Chave</strong></a>
<ul>
<li><a href="#registro-de-novo-usuário"
id="toc-registro-de-novo-usuário"><strong>8.1. Registro de Novo
Usuário</strong></a></li>
<li><a href="#login-e-seleção-de-perfil"
id="toc-login-e-seleção-de-perfil"><strong>8.2. Login e Seleção de
Perfil</strong></a></li>
<li><a href="#cadastro-de-idoso-para-responsáveis"
id="toc-cadastro-de-idoso-para-responsáveis"><strong>8.3. Cadastro de
Idoso (para Responsáveis)</strong></a></li>
</ul></li>
<li><a href="#deploy-vercel" id="toc-deploy-vercel"><strong>9. Deploy
(Vercel)</strong></a></li>
<li><a href="#pontos-de-atenção-e-oportunidades-de-melhoria"
id="toc-pontos-de-atenção-e-oportunidades-de-melhoria"><strong>10.
Pontos de Atenção e Oportunidades de Melhoria</strong></a></li>
<li><a href="#glossário-de-termos-técnicos"
id="toc-glossário-de-termos-técnicos"><strong>11. Glossário de Termos
Técnicos</strong></a></li>
<li><a href="#conclusão" id="toc-conclusão"><strong>12.
Conclusão</strong></a></li>
</ul></li>
</ul>
</nav>
<h1 id="análise-detalhada-do-projeto-projectcare"><strong>Análise
Detalhada do Projeto ProjectCare</strong></h1>
<h2 id="sumário"><strong>Sumário</strong></h2>
<ul>
<li><a href="#1-introdução"><strong>1. Introdução</strong></a></li>
<li><a href="#2-visão-geral-do-projeto"><strong>2. Visão Geral do
Projeto</strong></a>
<ul>
<li><a href="#21-propósito-e-funcionalidades">2.1. Propósito e
Funcionalidades</a></li>
<li><a href="#22-público-alvo">2.2. Público-Alvo</a></li>
</ul></li>
<li><a href="#3-arquitetura-e-tecnologias"><strong>3. Arquitetura e
Tecnologias</strong></a>
<ul>
<li><a href="#31-principais-tecnologias">3.1. Principais
Tecnologias</a></li>
<li><a href="#32-estrutura-do-projeto">3.2. Estrutura do
Projeto</a></li>
<li><a href="#33-fluxo-de-uma-requisição-http">3.3. Fluxo de uma
Requisição HTTP</a></li>
</ul></li>
<li><a href="#4-configuração-do-ambiente-de-desenvolvimento"><strong>4.
Configuração do Ambiente de Desenvolvimento</strong></a></li>
<li><a href="#5-análise-detalhada-do-código"><strong>5. Análise
Detalhada do Código</strong></a>
<ul>
<li><a
href="#51-ponto-de-entrada-da-aplicação-apprunpy-e-appinitpy">5.1. Ponto
de Entrada da Aplicação (app/run.py e
app/<strong>init</strong>.py)</a></li>
<li><a href="#52-modelos-de-dados-appmodels">5.2. Modelos de Dados
(app/models/)</a></li>
<li><a href="#53-rotas-e-controladores-approutes">5.3. Rotas e
Controladores (app/routes/)</a></li>
<li><a href="#54-camada-de-serviço-appservices">5.4. Camada de Serviço
(app/services/)</a></li>
<li><a href="#55-templates-apptemplates">5.5. Templates
(app/templates/)</a></li>
<li><a href="#56-arquivos-estáticos-appstatic">5.6. Arquivos Estáticos
(app/static/)</a></li>
<li><a href="#57-migrações-migrations">5.7. Migrações
(migrations/)</a></li>
<li><a href="#58-arquivos-raiz">5.8. Arquivos Raiz</a></li>
</ul></li>
<li><a href="#6-autenticação-e-gerenciamento-de-sessão"><strong>6.
Autenticação e Gerenciamento de Sessão</strong></a>
<ul>
<li><a href="#61-autenticação">6.1. Autenticação</a></li>
<li><a href="#62-segurança-de-senhas">6.2. Segurança de Senhas</a></li>
<li><a href="#63-gerenciamento-de-sessão">6.3. Gerenciamento de
Sessão</a></li>
</ul></li>
<li><a href="#7-interface-do-usuário-frontend"><strong>7. Interface do
Usuário (Frontend)</strong></a>
<ul>
<li><a href="#71-estrutura-de-templates">7.1. Estrutura de
Templates</a></li>
<li><a href="#72-tecnologias-frontend">7.2. Tecnologias
Frontend</a></li>
</ul></li>
<li><a href="#8-fluxos-de-usuário-chave"><strong>8. Fluxos de Usuário
Chave</strong></a>
<ul>
<li><a href="#81-registro-de-novo-usuário">8.1. Registro de Novo
Usuário</a></li>
<li><a href="#82-login-e-seleção-de-perfil">8.2. Login e Seleção de
Perfil</a></li>
<li><a href="#83-cadastro-de-idoso-para-responsáveis">8.3. Cadastro de
Idoso (para Responsáveis)</a></li>
</ul></li>
<li><a href="#9-deploy-vercel"><strong>9. Deploy
(Vercel)</strong></a></li>
<li><a
href="#10-pontos-de-atenção-e-oportunidades-de-melhoria"><strong>10.
Pontos de Atenção e Oportunidades de Melhoria</strong></a></li>
<li><a href="#11-glossário-de-termos-técnicos"><strong>11. Glossário de
Termos Técnicos</strong></a></li>
<li><a href="#12-conclusão"><strong>12. Conclusão</strong></a></li>
</ul>
<hr />
<h2 id="introdução"><strong>1. Introdução</strong></h2>
<p>Bem-vindo a esta análise detalhada do seu projeto ProjectCare! Como
seu “Especialista em Engenharia de Software e Documentação Técnica”, meu
papel aqui é funcionar como um professor, explicando pacientemente cada
aspecto do seu código. Vamos explorar juntos o propósito, a estrutura e
o funcionamento de cada componente, fornecendo insights sobre o fluxo
lógico, o uso de bibliotecas e frameworks, e possíveis melhorias. O
objetivo é que, ao final desta leitura, você tenha uma compreensão ainda
mais sólida do excelente trabalho que realizou.</p>
<h2 id="visão-geral-do-projeto"><strong>2. Visão Geral do
Projeto</strong></h2>
<p>Esta seção é baseada nas informações fornecidas no arquivo README.md
do seu projeto.</p>
<h3 id="propósito-e-funcionalidades">2.1. Propósito e
Funcionalidades</h3>
<p>O ProjectCare é uma plataforma web desenvolvida com o framework Flask
em Python. Seu principal objetivo é criar uma ponte entre Responsáveis
por idosos e Cuidadores qualificados. As funcionalidades centrais
incluem:</p>
<ul>
<li>Cadastro de usuários, que podem assumir o perfil de Cuidador,
Responsável, ou ambos.</li>
<li>Cadastro de idosos, sempre vinculados a um Responsável.</li>
<li>Listagem e visualização detalhada dos perfis dos Cuidadores.</li>
<li>Listagem e visualização dos idosos cadastrados.</li>
<li>Gerenciamento de contratos estabelecidos entre Cuidadores e
Responsáveis.</li>
</ul>
<h3 id="público-alvo">2.2. Público-Alvo</h3>
<p>A aplicação destina-se a dois grupos principais:</p>
<ul>
<li><strong>Responsáveis</strong>: Pessoas que buscam cuidadores para
idosos pelos quais são responsáveis.</li>
<li><strong>Cuidadores</strong>: Profissionais que oferecem serviços de
cuidados para idosos. ## <strong>3. Arquitetura e
Tecnologias</strong></li>
</ul>
<p>Esta seção detalha a arquitetura do sistema e as tecnologias
empregadas, com base no README.md.</p>
<h3 id="principais-tecnologias">3.1. Principais Tecnologias</h3>
<p>O ProjectCare utiliza um conjunto de tecnologias modernas para seu
desenvolvimento e funcionamento:</p>
<h4 id="backend"><strong>Backend:</strong></h4>
<ul>
<li><strong>Flask 3.1.0</strong>: Um microframework web Python,
conhecido por sua simplicidade e flexibilidade, usado para construir a
lógica da aplicação e as APIs.</li>
</ul>
<h4 id="orm-object-relational-mapper"><strong>ORM (Object-Relational
Mapper):</strong></h4>
<ul>
<li><strong>SQLAlchemy 2.0.40</strong>: Uma biblioteca SQL toolkit e ORM
que oferece uma forma poderosa e flexível de interagir com bancos de
dados relacionais usando Python.</li>
<li><strong>Flask-SQLAlchemy 3.1.1</strong>: Uma extensão para Flask que
integra o SQLAlchemy, facilitando o uso do ORM dentro de aplicações
Flask.</li>
</ul>
<h4 id="banco-de-dados"><strong>Banco de Dados:</strong></h4>
<ul>
<li><strong>PostgreSQL</strong>: Um sistema de gerenciamento de banco de
dados relacional objeto, robusto e de código aberto.</li>
<li><strong>psycopg2-binary 2.9.10</strong>: Um adaptador PostgreSQL
para Python, permitindo que a aplicação Python se comunique com o banco
de dados PostgreSQL.</li>
</ul>
<h4 id="migrações-de-banco-de-dados"><strong>Migrações de Banco de
Dados:</strong></h4>
<ul>
<li><strong>Flask-Migrate 4.1.0</strong>: Uma extensão para Flask que
lida com migrações de banco de dados SQLAlchemy usando Alembic.</li>
<li><strong>Alembic 1.15.2</strong>: Uma ferramenta de migração de banco
de dados para SQLAlchemy, permitindo o versionamento e a aplicação de
alterações no esquema do banco de dados.</li>
</ul>
<h4 id="autenticação"><strong>Autenticação:</strong></h4>
<ul>
<li><strong>Gerenciamento de sessão nativo do Flask</strong>: Utiliza o
sistema de sessões do Flask para controlar o estado de login dos
usuários.</li>
</ul>
<h4 id="segurança-de-senhas"><strong>Segurança de Senhas:</strong></h4>
<ul>
<li><strong>Argon2</strong> (via argon2-cffi 23.1.0): Um algoritmo de
hashing de senha moderno e seguro, usado para proteger as senhas dos
usuários no banco de dados.</li>
</ul>
<h4 id="frontend"><strong>Frontend:</strong></h4>
<ul>
<li><strong>Jinja2 3.1.6</strong>: Um motor de templates para Python,
usado pelo Flask para renderizar dinamicamente páginas HTML.</li>
<li><strong>Bootstrap 5.3.3</strong>: Um framework CSS popular para
criar interfaces de usuário responsivas e visualmente agradáveis.</li>
<li><strong>CSS customizado</strong>: Estilos específicos da aplicação
para complementar o Bootstrap.</li>
<li><strong>Biblioteca de animações AOS</strong>: Para adicionar
animações sutis durante o scroll da página.</li>
</ul>
<h4 id="configuração-de-ambiente"><strong>Configuração de
Ambiente:</strong></h4>
<ul>
<li><strong>python-dotenv 1.1.0</strong>: Uma biblioteca para carregar
variáveis de ambiente de um arquivo .env para o ambiente da
aplicação.</li>
</ul>
<h4 id="deploy"><strong>Deploy:</strong></h4>
<ul>
<li><strong>Vercel</strong>: Uma plataforma de cloud para hospedar
aplicações web estáticas e dinâmicas, como o ProjectCare. ### 3.2.
Estrutura do Projeto</li>
</ul>
<p>A estrutura de pastas do projeto é bem organizada, seguindo
convenções comuns em aplicações Flask, o que facilita a manutenção e o
desenvolvimento.</p>
<pre><code>ProjectCare/
├── app/                        # Pacote principal da aplicação Flask
│   ├── __init__.py             # Inicialização da aplicação Flask e extensões
│   ├── config/                 # Configurações (securityconfig.py mencionado, mas não fornecido)
│   │   └── securityconfig.py   # Configurações de segurança (não fornecido)
│   ├── models/                 # Modelos de dados (SQLAlchemy)
│   │   ├── __init__.py         # Torna &#39;models&#39; um pacote Python e importa os modelos
│   │   ├── caregiver.py        # Modelo de Cuidador
│   │   ├── contract.py         # Modelo de Contrato
│   │   ├── elderly.py          # Modelo de Idoso
│   │   ├── responsible.py      # Modelo de Responsável
│   │   └── user.py             # Modelo de Usuário (base para Caregiver e Responsible)
│   ├── routes/                 # Rotas/Blueprints da aplicação
│   │   ├── __init__.py         # Torna &#39;routes&#39; um pacote Python
│   │   ├── caregivers.py       # Rotas relacionadas a cuidadores
│   │   ├── contact.py          # Rota para a página de contato
│   │   ├── home.py             # Rotas para página inicial e logout
│   │   ├── login.py            # Rotas para login, logout e seleção de perfil de atuação
│   │   ├── register.py         # Rotas para registro de usuários e perfis
│   │   ├── responsible_dashboard.py # Rotas para o painel de responsáveis
│   │   └── user.py             # Rotas para gerenciamento de perfis de usuário
│   ├── services/               # Lógica de negócios da aplicação
│   │   ├── __init__.py         # Torna &#39;services&#39; um pacote e instancia os serviços
│   │   ├── caregiver_service.py # Serviço com lógica para cuidadores
│   │   ├── elderly_service.py   # Serviço com lógica para idosos
│   │   ├── responsible_service.py # Serviço com lógica para responsáveis
│   │   └── user_service.py      # Serviço com lógica para usuários
│   ├── static/                 # Arquivos estáticos (CSS, JavaScript, Imagens)
│   │   ├── css/
│   │   │   └── style.css       # Folha de estilos customizada
│   │   └── images/             # Imagens utilizadas na aplicação
│   ├── templates/              # Templates HTML (Jinja2)
│   │   ├── base.html           # Template base que outros templates herdam
│   │   ├── contact/            # Templates para a seção de contato
│   │   ├── fragments/          # Pequenos pedaços de HTML reutilizáveis (navbar, footer, flash messages)
│   │   ├── home/               # Templates para a página inicial
│   │   ├── list/               # Templates para listagens (cuidadores, idosos)
│   │   ├── login/              # Templates para login e seleção de perfil de atuação
│   │   └── register/           # Templates para as várias etapas de registro
│   └── run.py                  # Ponto de entrada da aplicação para execução e deploy (Vercel)
├── migrations/                 # Arquivos de migração do banco de dados (Alembic)
│   ├── versions/               # Scripts de versão das migrações
│   ├── alembic.ini             # Arquivo de configuração do Alembic
│   ├── env.py                  # Script de ambiente do Alembic, configura como as migrações são executadas
│   ├── README                  # Informações sobre as migrações
│   └── script.py.mako          # Template para gerar novos scripts de migração
├── config.py                   # Configurações gerais (mencionado no README, mas não fornecido. App usa .env)
├── requirements.txt            # Lista de dependências Python do projeto
└── vercel.json                 # Arquivo de configuração para deploy na Vercel</code></pre>
<h3 id="fluxo-de-uma-requisição-http">3.3. Fluxo de uma Requisição
HTTP</h3>
<p>O README.md descreve bem o fluxo de uma requisição HTTP:</p>
<ol type="1">
<li><strong>Cliente</strong>: O usuário, através do navegador, faz uma
requisição HTTP para uma URL da aplicação (ex:
www.projectcare.com/login).</li>
<li><strong>Vercel</strong>: Se a aplicação estiver em produção na
Vercel, ela recebe a requisição e a direciona para o ponto de entrada
configurado, que é app/run.py.</li>
<li><strong>Flask (app/run.py -&gt;
app/<strong>init</strong>.py)</strong>:
<ul>
<li>O app/run.py cria uma instância da aplicação Flask chamando
create_app() de app/<strong>init</strong>.py.</li>
<li>A instância do Flask recebe a requisição.</li>
<li>O Flask analisa a URL da requisição e, com base nas rotas
registradas pelos Blueprints (em app/routes/), encaminha a requisição
para a função controladora (view function) correspondente.</li>
</ul></li>
<li><strong>Função Controladora (Rota em app/routes/)</strong>:
<ul>
<li>A função associada à rota é executada. Por exemplo, se a URL for
/login, a função login() no arquivo app/routes/login.py será
chamada.</li>
<li>Esta função pode interagir com a camada de serviço (app/services/)
para buscar ou salvar dados, ou executar lógicas de negócio.</li>
</ul></li>
<li><strong>Serviços (app/services/)</strong>:
<ul>
<li>Os serviços contêm a lógica de negócios. Eles interagem com os
modelos de dados (app/models/) para realizar operações no banco de dados
(consultas, inserções, atualizações) via SQLAlchemy.</li>
</ul></li>
<li><strong>Renderização do Template (Função Controladora)</strong>:
<ul>
<li>Após processar a lógica e obter os dados necessários, a função
controladora geralmente renderiza um template Jinja2 (app/templates/).
Ela passa os dados para o template, que os utiliza para construir a
página HTML dinamicamente.</li>
</ul></li>
<li><strong>Resposta HTTP (Flask)</strong>:
<ul>
<li>O Flask pega o HTML renderizado (ou outra resposta, como um JSON ou
um redirecionamento) e o envia de volta ao cliente como uma resposta
HTTP. O navegador do cliente então exibe a página. ## <strong>4.
Configuração do Ambiente de Desenvolvimento</strong></li>
</ul></li>
</ol>
<p>O README.md fornece instruções claras para configurar o ambiente de
desenvolvimento. Relembrando os passos principais:</p>
<h3 id="pré-requisitos"><strong>Pré-requisitos:</strong></h3>
<ul>
<li>Python 3.8 ou superior</li>
<li>PostgreSQL</li>
</ul>
<h3 id="instalação"><strong>Instalação:</strong></h3>
<ol type="1">
<li><strong>Clonar o repositório</strong>:</li>
</ol>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone <span class="op">&lt;</span>url-do-repositorio<span class="op">&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ProjectCare</span></code></pre></div>
<ol start="2" type="1">
<li><strong>Criar e ativar um ambiente virtual</strong>:</li>
</ol>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> venv venv</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># No Windows</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">venv\Scripts\activate</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># No Linux/Mac</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> venv/bin/activate</span></code></pre></div>
<p>Isso é crucial para isolar as dependências do projeto.</p>
<ol start="3" type="1">
<li><strong>Instalar as dependências</strong>:</li>
</ol>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span></code></pre></div>
<p>O arquivo requirements.txt lista todas as bibliotecas Python que o
projeto necessita.</p>
<ol start="4" type="1">
<li><strong>Criar arquivo .env</strong>: Na raiz do projeto, crie um
arquivo chamado .env com as seguintes variáveis (substitua pelos seus
valores):</li>
</ol>
<pre><code>SECRET_KEY=sua_chave_secreta_aqui
DATABASE_URL=postgresql://usuario:senha@localhost/projectcare</code></pre>
<ul>
<li>SECRET_KEY: Usada pelo Flask para segurança de sessões e outras
funcionalidades.</li>
<li>DATABASE_URL: String de conexão para o seu banco de dados
PostgreSQL.</li>
</ul>
<h3 id="configuração-do-banco-de-dados"><strong>Configuração do Banco de
Dados:</strong></h3>
<ol type="1">
<li><strong>Criar o banco de dados no PostgreSQL</strong>:</li>
</ol>
<div class="sourceCode" id="cb6"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">DATABASE</span> projectcare;</span></code></pre></div>
<ol start="2" type="1">
<li><strong>Executar as migrações</strong>: Para criar as tabelas no
banco de dados com base nos modelos definidos.</li>
</ol>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">flask</span> db upgrade</span></code></pre></div>
<p>Isso utiliza o Flask-Migrate e o Alembic para aplicar as migrações
encontradas na pasta migrations/versions/.</p>
<h3 id="executando-a-aplicação"><strong>Executando a
Aplicação:</strong></h3>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> app.run</span></code></pre></div>
<p>A aplicação estará disponível em http://localhost:5000 (ou a porta
que o Flask designar, se a 5000 estiver ocupada).</p>
<h2 id="análise-detalhada-do-código"><strong>5. Análise Detalhada do
Código</strong></h2>
<p>Agora, vamos analisar os arquivos de código do seu projeto,
explicando o propósito e funcionamento de cada parte principal.</p>
<h3 id="ponto-de-entrada-da-aplicação-apprun.py-e-appinit.py">5.1. Ponto
de Entrada da Aplicação (app/run.py e app/<strong>init</strong>.py)</h3>
<p>Estes dois arquivos são fundamentais para iniciar e configurar sua
aplicação Flask.</p>
<h4 id="apprun.py"><strong>app/run.py</strong></h4>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> . <span class="im">import</span> create_app  <span class="co"># 1</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging            <span class="co"># 2</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> create_app()        <span class="co"># 3</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ativa logs detalhados do Flask e SQLAlchemy # 4</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>logging.basicConfig(level<span class="op">=</span>logging.DEBUG)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>logging.getLogger(<span class="st">&#39;sqlalchemy.engine&#39;</span>).setLevel(logging.INFO)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>: <span class="co"># 5</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    app.run(debug<span class="op">=</span><span class="va">True</span>)    <span class="co"># 6</span></span></code></pre></div>
<p><strong>Explicação do app/run.py</strong>:</p>
<ol type="1">
<li><code>from . import create_app</code>: Importa a função create_app
do arquivo <strong>init</strong>.py que está no mesmo diretório (app).
Esta função é uma fábrica de aplicações (Application Factory), um padrão
recomendado em Flask para criar e configurar a instância da
aplicação.</li>
<li><code>import logging</code>: Importa o módulo de logging do Python,
usado para registrar informações sobre a execução da aplicação, o que é
muito útil para depuração.</li>
<li><code>app = create_app()</code>: Chama a função create_app() para
criar e configurar a instância da aplicação Flask. O objeto app
retornado é a sua aplicação web.</li>
<li><strong>Configuração de Logging</strong>:
<ul>
<li><code>logging.basicConfig(level=logging.DEBUG)</code>: Configura o
logging básico para exibir mensagens a partir do nível DEBUG (o mais
detalhado).</li>
<li><code>logging.getLogger('sqlalchemy.engine').setLevel(logging.INFO)</code>:
Configura o logger específico do SQLAlchemy para exibir mensagens a
partir do nível INFO, o que é útil para ver as queries SQL geradas pelo
SQLAlchemy, por exemplo.</li>
</ul></li>
<li><code>if __name__ == '__main__':</code>: Esta é uma construção
padrão em Python. O bloco de código dentro deste if só será executado se
o script run.py for executado diretamente (ex: python app/run.py). Ele
não será executado se run.py for importado por outro módulo.</li>
<li><code>app.run(debug=True)</code>: Inicia o servidor de
desenvolvimento embutido do Flask.
<ul>
<li><code>debug=True</code>: Ativa o modo de depuração do Flask. Isso é
extremamente útil durante o desenvolvimento, pois fornece mensagens de
erro detalhadas no navegador, recarrega automaticamente o servidor
quando o código é alterado, e permite o uso do depurador interativo do
Werkzeug. Importante: Nunca use debug=True em um ambiente de produção
por razões de segurança e desempenho.</li>
</ul></li>
</ol>
<p>Este arquivo é o ponto de entrada para a Vercel, conforme definido em
vercel.json.</p>
<h4 id="appinit.py"><strong>app/<strong>init</strong>.py</strong></h4>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask, session  <span class="co"># 1</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_sqlalchemy <span class="im">import</span> SQLAlchemy <span class="co"># 2</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_migrate <span class="im">import</span> Migrate <span class="co"># 3</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv    <span class="co"># 4</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os                         <span class="co"># 5</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>load_dotenv(override<span class="op">=</span><span class="va">True</span>) <span class="co">#override para sobescrever as variaveis # 6</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> SQLAlchemy() <span class="co"># 7</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>migrate <span class="op">=</span> Migrate() <span class="co"># 8</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_app(): <span class="co"># 9</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    app <span class="op">=</span> Flask(<span class="va">__name__</span>) <span class="co"># 10</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica se as variáveis obrigatórias estão definidas # 11</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    required_env_vars <span class="op">=</span> [<span class="st">&#39;SECRET_KEY&#39;</span>, <span class="st">&#39;DATABASE_URL&#39;</span>]</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> required_env_vars:</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.getenv(var):</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="ss">f&quot;A variável de ambiente &#39;</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">&#39; não está definida. Verifique o arquivo .env.&quot;</span>)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configuração do app # 12</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    app.config[<span class="st">&#39;SECRET_KEY&#39;</span>] <span class="op">=</span> os.getenv(<span class="st">&#39;SECRET_KEY&#39;</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    app.config[<span class="st">&#39;SQLALCHEMY_DATABASE_URI&#39;</span>] <span class="op">=</span> os.getenv(<span class="st">&#39;DATABASE_URL&#39;</span>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    app.config[<span class="st">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span>] <span class="op">=</span> <span class="va">False</span> <span class="co"># 13</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extensões # 14</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    db.init_app(app)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    migrate.init_app(app, db)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> app.app_context(): <span class="co"># 15</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        db.create_all()  <span class="co"># Cria as tabelas no banco de dados se não existirem # 16</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">@app.context_processor</span> <span class="co"># 17</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> inject_user(): <span class="co"># 18</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="co">        Injeta o usuário na sessão para acesso em templates.</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">&#39;user_id&#39;</span> <span class="kw">in</span> session: <span class="co"># 19</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="st">&#39;navbar_template&#39;</span>: <span class="st">&#39;fragments/navbar_login.html&#39;</span>} <span class="co"># 20</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">&#39;navbar_template&#39;</span>: <span class="st">&#39;fragments/navbar.html&#39;</span>} <span class="co"># 21</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Registro de blueprints # 22</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> app.routes.home <span class="im">import</span> home_bp</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> app.routes.caregivers <span class="im">import</span> caregivers_bp</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> app.routes.contact <span class="im">import</span> contact_bp</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> app.routes.login <span class="im">import</span> login_bp</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> app.routes.register <span class="im">import</span> register_bp</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> app.routes.responsible_dashboard <span class="im">import</span> responsible_dashboard_bp</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Nota: app.routes.user_bp não está sendo registrado aqui, embora exista o arquivo user.py em routes.</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>    app.register_blueprint(home_bp) <span class="co"># 23</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    app.register_blueprint(caregivers_bp)</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    app.register_blueprint(contact_bp)</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    app.register_blueprint(login_bp)</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    app.register_blueprint(register_bp)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    app.register_blueprint(responsible_dashboard_bp)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> app <span class="co"># 24</span></span></code></pre></div>
<p><strong>Explicação do app/<strong>init</strong>.py</strong>:</p>
<ol type="1">
<li><p><strong>Importações Iniciais</strong>:</p>
<ul>
<li><code>Flask, session</code>: Componentes principais do Flask. Flask
é a classe para criar a aplicação, session é usada para armazenar dados
específicos do usuário entre requisições.</li>
<li><code>flask_sqlalchemy import SQLAlchemy</code>: Importa a classe
SQLAlchemy da extensão Flask-SQLAlchemy, que facilita a integração do
SQLAlchemy com o Flask.</li>
<li><code>flask_migrate import Migrate</code>: Importa a classe Migrate
da extensão Flask-Migrate, para gerenciar migrações do banco de
dados.</li>
<li><code>dotenv import load_dotenv</code>: Importa a função para
carregar variáveis de ambiente de um arquivo .env.</li>
<li><code>import os</code>: Módulo do sistema operacional, usado aqui
para acessar variáveis de ambiente.</li>
</ul></li>
<li><p><code>load_dotenv(override=True)</code>: Carrega as variáveis
definidas no arquivo .env (se existir na raiz do projeto) para o
ambiente da aplicação. override=True significa que se uma variável de
ambiente já existir, ela será sobrescrita pelo valor do arquivo
.env.</p></li>
<li><p><code>db = SQLAlchemy()</code>: Cria uma instância do objeto
SQLAlchemy. Esta instância db será usada para definir os modelos e
interagir com o banco de dados.</p></li>
<li><p><code>migrate = Migrate()</code>: Cria uma instância do objeto
Migrate. Esta instância será usada para configurar o
Flask-Migrate.</p></li>
<li><p><code>def create_app()</code>: Define a função fábrica da
aplicação.</p></li>
<li><p><code>app = Flask(__name__)</code>: Cria a instância da aplicação
Flask. <strong>name</strong> é uma variável especial em Python que
representa o nome do módulo atual. O Flask usa isso para localizar
recursos como templates e arquivos estáticos.</p></li>
<li><p><strong>Verificação de Variáveis de Ambiente</strong>: Um loop
verifica se as variáveis de ambiente obrigatórias (SECRET_KEY,
DATABASE_URL) estão definidas. Se alguma não estiver, uma RuntimeError é
levantada, impedindo a aplicação de iniciar sem configurações
essenciais. Isso é uma boa prática para garantir que a aplicação tenha o
mínimo necessário para rodar.</p></li>
<li><p><strong>Configuração do App</strong>:</p>
<ul>
<li><code>app.config['SECRET_KEY'] = os.getenv('SECRET_KEY')</code>:
Define a chave secreta do Flask, crucial para a segurança das sessões e
outros elementos criptográficos.</li>
<li><code>app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('DATABASE_URL')</code>:
Define a URI de conexão com o banco de dados SQLAlchemy, informando onde
o banco de dados está e como se conectar a ele.</li>
<li><code>app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False</code>:
Desativa o rastreamento de modificações do SQLAlchemy, que pode consumir
recursos desnecessários se não for utilizado. É uma configuração comum
para otimizar o desempenho.</li>
</ul></li>
<li><p><strong>Inicialização de Extensões</strong>:</p>
<ul>
<li><code>db.init_app(app)</code>: Inicializa a extensão SQLAlchemy com
a aplicação Flask.</li>
<li><code>migrate.init_app(app, db)</code>: Inicializa a extensão
Flask-Migrate, associando-a à aplicação Flask e à instância do
SQLAlchemy (db).</li>
</ul></li>
<li><p><strong>Criação de Tabelas</strong>:</p>
<ul>
<li><code>with app.app_context()</code>: Cria um contexto de aplicação.
Certas operações do Flask e suas extensões (como interagir com o banco
de dados) precisam que um contexto de aplicação ou de requisição esteja
ativo.</li>
<li><code>db.create_all()</code>: Este comando verifica se as tabelas
definidas nos seus modelos SQLAlchemy (em app/models/) existem no banco
de dados. Se não existirem, ele as cria. Atenção: db.create_all() não
realiza migrações (alterações em tabelas existentes). Para isso, usa-se
o Flask-Migrate (flask db migrate, flask db upgrade). É comum ter
db.create_all() para a configuração inicial, mas em um fluxo de
desenvolvimento com migrações, as migrações é que devem gerenciar o
esquema do banco após a criação inicial. O README.md instrui a usar
flask db upgrade, o que é o correto para um sistema com migrações. Ter
db.create_all() aqui pode ser redundante ou até causar conflitos se as
migrações não estiverem perfeitamente alinhadas. Geralmente, para
projetos usando Flask-Migrate, db.create_all() é omitido após a
configuração inicial das migrações.</li>
</ul></li>
<li><p><strong>Context Processor</strong>:</p>
<ul>
<li><code>@app.context_processor</code>: Este é um decorador do Flask
que registra uma função para ser executada antes de renderizar um
template. O dicionário retornado pela função é injetado no contexto do
template, tornando suas chaves disponíveis como variáveis em todos os
templates.</li>
<li><code>def inject_user()</code>: A função que será o processador de
contexto.</li>
<li><code>if 'user_id' in session:</code>: Verifica se user_id está
presente na sessão do usuário, o que indica que o usuário está
logado.</li>
<li><code>return {'navbar_template': 'fragments/navbar_login.html'}</code>:
Se o usuário estiver logado, define a variável navbar_template no
contexto do template para o caminho da barra de navegação de usuários
logados.</li>
<li><code>return {'navbar_template': 'fragments/navbar.html'}</code>: Se
o usuário não estiver logado, define navbar_template para a barra de
navegação padrão. No seu base.html, você provavelmente usa {% include
navbar_template %} para renderizar a navbar correta.</li>
</ul></li>
<li><p><strong>Registro de Blueprints</strong>:</p>
<ul>
<li><strong>Importações</strong>: Importa as instâncias de Blueprint
definidas nos seus arquivos de rotas. Blueprints são usados para
organizar uma aplicação Flask em componentes modulares.</li>
<li><strong>Registro</strong>: <code>app.register_blueprint(...)</code>:
Registra cada blueprint na aplicação Flask. Isso torna as rotas
definidas em cada blueprint ativas e acessíveis.</li>
<li><strong>Observação</strong>: O arquivo app/routes/user.py define um
user_bp, mas ele não está sendo registrado aqui em
app/<strong>init</strong>.py. Isso significa que as rotas definidas em
app/routes/user.py (como /user/profiles) não estarão acessíveis na
aplicação, a menos que sejam registradas em outro lugar ou que este seja
um trecho de código incompleto/desatualizado.</li>
</ul></li>
<li><p><code>return app</code>: A função fábrica retorna a instância da
aplicação Flask configurada. ### 5.2. Modelos de Dados
(app/models/)</p></li>
</ol>
<p>Os modelos de dados definem a estrutura das tabelas do seu banco de
dados e como elas se relacionam. Eles são classes Python que herdam de
db.Model (fornecido pelo Flask-SQLAlchemy).</p>
<h4
id="appmodelsinit.py"><strong>app/models/<strong>init</strong>.py</strong></h4>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.caregiver <span class="im">import</span> Caregiver <span class="co"># 1</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.responsible <span class="im">import</span> Responsible <span class="co"># 2</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.elderly <span class="im">import</span> Elderly <span class="co"># 3</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.contract <span class="im">import</span> Contract <span class="co"># 4</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># O modelo User não é explicitamente importado aqui,</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># mas é fundamental pois Caregiver e Responsible dependem dele.</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Ele é importado diretamente onde necessário nos outros modelos.</span></span></code></pre></div>
<p><strong>Explicação do
app/models/<strong>init</strong>.py</strong>:</p>
<p>Este arquivo tem dois propósitos principais:</p>
<ol type="1">
<li>Tornar o diretório models um pacote Python, permitindo importações
como <code>from app.models import User</code>.</li>
<li>Convenientemente importar os modelos para que possam ser acessados a
partir do pacote app.models (embora no seu caso, eles sejam mais
frequentemente importados diretamente, ex:
<code>from app.models.user import User</code>). As importações aqui são
mais para garantir que o SQLAlchemy descubra os modelos quando, por
exemplo, <code>db.create_all()</code> é chamado ou quando o Alembic gera
migrações, se os modelos não forem importados em outro lugar central
(como no <strong>init</strong>.py principal da aplicação antes de
db.create_all()). #### <strong>app/models/user.py</strong></li>
</ol>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># app/models/user.py</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> argon2 <span class="im">import</span> PasswordHasher             <span class="co"># 1</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> argon2.exceptions <span class="im">import</span> VerifyMismatchError <span class="co"># 2</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime                 <span class="co"># 3</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app <span class="im">import</span> db                            <span class="co"># 4</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#em qualquer lugar do código que o db.algo existir, o algo é um método do SQLAlchemy com parametros</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>ph <span class="op">=</span> PasswordHasher( <span class="co"># 5</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    time_cost<span class="op">=</span><span class="dv">5</span>,        <span class="co"># Quantidade de iterações (quanto maior, mais seguro, mas mais lento)</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    memory_cost<span class="op">=</span><span class="dv">131072</span>,  <span class="co"># Quantidade de memória usada em KiB (128 MiB)</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    parallelism<span class="op">=</span><span class="dv">10</span>,      <span class="co"># Número de threads (maior paralelismo = mais rápido)</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    hash_len<span class="op">=</span><span class="dv">64</span>,        <span class="co"># Comprimento do hash gerado</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    salt_len<span class="op">=</span><span class="dv">16</span>         <span class="co"># Comprimento do salt gerado</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> User(db.Model): <span class="co"># 6</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    __tablename__ <span class="op">=</span> <span class="st">&quot;users&quot;</span> <span class="co"># 7</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> db.Column(db.Integer, primary_key<span class="op">=</span><span class="va">True</span>) <span class="co"># 8</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">False</span>) <span class="co"># 9</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    cpf <span class="op">=</span> db.Column(db.String(<span class="dv">17</span>), unique<span class="op">=</span><span class="va">True</span>, nullable<span class="op">=</span><span class="va">False</span>) <span class="co"># 10</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    gender <span class="op">=</span> db.Column(db.String(<span class="dv">20</span>), nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    birthdate <span class="op">=</span> db.Column(db.Date, nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    phone <span class="op">=</span> db.Column(db.String(<span class="dv">20</span>), unique<span class="op">=</span><span class="va">True</span>, nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    email <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), unique<span class="op">=</span><span class="va">True</span>, nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    password_hash <span class="op">=</span> db.Column(db.String(<span class="dv">200</span>), nullable<span class="op">=</span><span class="va">False</span>) <span class="co"># 11</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    address <span class="op">=</span> db.Column(db.String(<span class="dv">255</span>), nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    city <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    created_at <span class="op">=</span> db.Column(db.DateTime, default<span class="op">=</span>datetime.utcnow) <span class="co"># 12</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Relações # 13</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    caregiver <span class="op">=</span> db.relationship(<span class="st">&quot;Caregiver&quot;</span>, back_populates<span class="op">=</span><span class="st">&quot;user&quot;</span>, uselist<span class="op">=</span><span class="va">False</span>) <span class="co"># 14</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    responsible <span class="op">=</span> db.relationship(<span class="st">&quot;Responsible&quot;</span>, back_populates<span class="op">=</span><span class="st">&quot;user&quot;</span>, uselist<span class="op">=</span><span class="va">False</span>) <span class="co"># 15</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># elderly = db.relationship(&quot;Elderly&quot;, back_populates=&quot;user&quot;, uselist=False)  # Removido: não há mais FK para elderly</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name, cpf, gender, birthdate, phone, email, password, address, city, state): <span class="co"># 16</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cpf <span class="op">=</span> cpf</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gender <span class="op">=</span> gender</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.birthdate <span class="op">=</span> birthdate</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.phone <span class="op">=</span> phone</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.email <span class="op">=</span> email</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.set_password(password) <span class="co"># 17</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.address <span class="op">=</span> address</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.city <span class="op">=</span> city</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state <span class="op">=</span> state</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_password(<span class="va">self</span>, password): <span class="co"># 18</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Hash the password and store it.&quot;&quot;&quot;</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.password_hash <span class="op">=</span> ph.<span class="bu">hash</span>(password) <span class="co"># 19</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> check_password(<span class="va">self</span>, password): <span class="co"># 20</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Check the password against the stored hash.&quot;&quot;&quot;</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>            ph.verify(<span class="va">self</span>.password_hash, password) <span class="co"># 21</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> VerifyMismatchError: <span class="co"># 22</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>): <span class="co"># 23</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f&quot;&lt;User </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>name<span class="sc">}</span><span class="ss">&gt;&quot;</span></span></code></pre></div>
<p><strong>Explicação do app/models/user.py</strong>:</p>
<ol type="1">
<li><strong>Importações</strong>:
<ul>
<li><code>from argon2 import PasswordHasher</code>: Importa a classe
PasswordHasher da biblioteca argon2-cffi, usada para criar hashes de
senha seguros.</li>
<li><code>from argon2.exceptions import VerifyMismatchError</code>:
Importa a exceção específica que é levantada pelo Argon2 quando a
verificação de uma senha falha.</li>
<li><code>from datetime import datetime</code>: Importa a classe
datetime para trabalhar com datas e horas, especificamente para o campo
created_at.</li>
<li><code>from app import db</code>: Importa a instância db do
SQLAlchemy, criada em app/<strong>init</strong>.py. Esta instância é
usada para definir modelos e interagir com o banco.</li>
</ul></li>
<li><strong>Configuração do PasswordHasher (Argon2)</strong>:
<ul>
<li><code>ph = PasswordHasher(...)</code>: Cria uma instância do
PasswordHasher com parâmetros específicos. Estes parâmetros controlam o
quão “caro” (demorado e custoso em termos de memória) é calcular o hash.
Valores mais altos tornam o hash mais resistente a ataques de força
bruta.</li>
<li><code>time_cost</code>: Número de iterações.</li>
<li><code>memory_cost</code>: Memória em KiB.</li>
<li><code>parallelism</code>: Número de threads paralelas.</li>
<li><code>hash_len</code>: Comprimento do hash resultante.</li>
<li><code>salt_len</code>: Comprimento do “sal” (um valor aleatório
adicionado à senha antes do hashing para aumentar a segurança).</li>
</ul></li>
<li><strong>Definição da Classe</strong>:
<ul>
<li><code>class User(db.Model)</code>: Define a classe User que
representa a tabela de usuários. Ela herda de db.Model, que é a classe
base para todos os modelos no Flask-SQLAlchemy.</li>
<li><code>__tablename__ = "users"</code>: Especifica o nome da tabela no
banco de dados como “users”. Se omitido, o Flask-SQLAlchemy usaria um
nome derivado do nome da classe (ex: “user”).</li>
</ul></li>
<li><strong>Definição de Colunas (Atributos da Classe)</strong>:
<ul>
<li>Cada atributo da classe definido com db.Column representa uma coluna
na tabela users.</li>
<li><code>id = db.Column(db.Integer, primary_key=True)</code>: Define a
coluna id como um inteiro e chave primária da tabela. primary_key=True
implica que será autoincrementável por padrão na maioria dos bancos de
dados.</li>
<li><code>name = db.Column(db.String(100), nullable=False)</code>:
Define a coluna name como uma string de até 100 caracteres.
nullable=False significa que esta coluna não pode ter valores
nulos.</li>
<li><code>cpf = db.Column(db.String(17), unique=True, nullable=False)</code>:
Coluna cpf como string, com restrição de unicidade (unique=True).</li>
<li>Os demais campos (gender, birthdate, phone, email, address, city,
state) seguem um padrão similar, definindo o tipo de dado, e restrições
como unique e nullable.</li>
<li><code>password_hash = db.Column(db.String(200), nullable=False)</code>:
Armazena o hash da senha do usuário, nunca a senha em texto plano. O
tamanho (200) deve ser suficiente para o hash Argon2.</li>
<li><code>created_at = db.Column(db.DateTime, default=datetime.utcnow)</code>:
Armazena a data e hora de criação do registro. default=datetime.utcnow
define que o valor padrão será o timestamp UTC atual no momento da
inserção.</li>
<li><code>nullable=False</code>: Esta restrição garante que um valor
deve ser fornecido para esta coluna ao criar ou atualizar um
registro.</li>
<li><code>unique=True</code>: Esta restrição garante que todos os
valores nesta coluna devem ser únicos em toda a tabela.</li>
</ul></li>
<li><strong>Relacionamentos</strong>:
<ul>
<li>Definem como o modelo User se conecta a outros modelos.</li>
<li><code>caregiver = db.relationship("Caregiver", back_populates="user", uselist=False)</code>:
Define um relacionamento um-para-um (ou um-para-zero) com o modelo
Caregiver.
<ul>
<li><code>"Caregiver"</code>: O nome da classe do modelo
relacionado.</li>
<li><code>back_populates="user"</code>: Especifica que no modelo
Caregiver, existe um relacionamento chamado user que aponta de volta
para este modelo User. Isso cria um relacionamento bidirecional.</li>
<li><code>uselist=False</code>: Indica que este lado do relacionamento
(user.caregiver) se refere a um único objeto Caregiver (ou None), e não
a uma lista. Isso é característico de um relacionamento um-para-um.</li>
</ul></li>
<li><code>responsible = db.relationship("Responsible", back_populates="user", uselist=False)</code>:
Similar ao relacionamento com Caregiver, define um relacionamento
um-para-um com o modelo Responsible.</li>
</ul></li>
<li><strong>Métodos</strong>:
<ul>
<li><code>def __init__(self, ...)</code>: O construtor da classe User. É
chamado quando você cria uma nova instância de User (ex: novo_usuario =
User(…)). Ele inicializa os atributos do objeto.</li>
<li><code>self.set_password(password)</code>: Chama o método
set_password para fazer o hash da senha fornecida antes de
armazená-la.</li>
<li><code>def set_password(self, password)</code>: Método para definir a
senha do usuário.
<ul>
<li><code>self.password_hash = ph.hash(password)</code>: Usa a instância
ph do PasswordHasher (Argon2) para gerar um hash seguro da senha e o
armazena no atributo password_hash.</li>
</ul></li>
<li><code>def check_password(self, password)</code>: Método para
verificar se uma senha fornecida corresponde à senha com hash
armazenada.
<ul>
<li><code>ph.verify(self.password_hash, password)</code>: Tenta
verificar a senha fornecida (password) contra o hash armazenado
(self.password_hash). Se a senha corresponder, o método não faz nada
(continua para o return True).</li>
<li><code>except VerifyMismatchError</code>: Se a senha não
corresponder, o Argon2 levanta uma VerifyMismatchError. O bloco except
captura essa exceção e o método retorna False.</li>
</ul></li>
<li><code>def __repr__(self)</code>: O método “representação”. Define
como um objeto User deve ser exibido, por exemplo, ao usar print() em
uma instância ou em logs. É útil para depuração. Retorna uma string como
<User NomeDoUsuario>. #### app/models/caregiver.py</li>
</ul></li>
</ol>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># app/models/caregiver.py</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app <span class="im">import</span> db <span class="co"># 1</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">#em qualquer lugar do código que o db.algo existir, o algo é um método do SQLAlchemy com parametros</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Caregiver(db.Model): <span class="co"># 2</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    __tablename__ <span class="op">=</span> <span class="st">&quot;caregiver&quot;</span> <span class="co"># 3</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> db.Column(db.Integer, primary_key<span class="op">=</span><span class="va">True</span>) <span class="co"># 4</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    specialty <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    experience <span class="op">=</span> db.Column(db.Integer, nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    education <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    expertise_area <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    skills <span class="op">=</span> db.Column(db.String(<span class="dv">500</span>), nullable<span class="op">=</span><span class="va">False</span>) <span class="co"># Modificado pela migração para 500</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    rating <span class="op">=</span> db.Column(db.Float, nullable<span class="op">=</span><span class="va">False</span>, default<span class="op">=</span><span class="fl">0.0</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    dias_disponiveis <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">True</span>) <span class="co"># 5</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    periodos_disponiveis <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    inicio_imediato <span class="op">=</span> db.Column(db.Boolean, nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    pretensao_salarial <span class="op">=</span> db.Column(db.Float, nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    user_id <span class="op">=</span> db.Column(db.Integer, db.ForeignKey(<span class="st">&quot;users.id&quot;</span>), nullable<span class="op">=</span><span class="va">False</span>) <span class="co"># 6</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    user <span class="op">=</span> db.relationship(<span class="st">&quot;User&quot;</span>, back_populates<span class="op">=</span><span class="st">&quot;caregiver&quot;</span>) <span class="co"># 7</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    contracts <span class="op">=</span> db.relationship(<span class="st">&quot;Contract&quot;</span>, back_populates<span class="op">=</span><span class="st">&quot;caregiver&quot;</span>, cascade<span class="op">=</span><span class="st">&quot;all, delete-orphan&quot;</span>) <span class="co"># 8</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, user, specialty, experience, education, expertise_area, skills, rating<span class="op">=</span><span class="fl">0.0</span>, <span class="co"># 9</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>                 dias_disponiveis<span class="op">=</span><span class="va">None</span>, periodos_disponiveis<span class="op">=</span><span class="va">None</span>, inicio_imediato<span class="op">=</span><span class="va">None</span>, pretensao_salarial<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.user <span class="op">=</span> user</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.specialty <span class="op">=</span> specialty</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.experience <span class="op">=</span> experience</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.education <span class="op">=</span> education</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.expertise_area <span class="op">=</span> expertise_area</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.skills <span class="op">=</span> skills</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rating <span class="op">=</span> rating</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dias_disponiveis <span class="op">=</span> dias_disponiveis</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.periodos_disponiveis <span class="op">=</span> periodos_disponiveis</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.inicio_imediato <span class="op">=</span> inicio_imediato</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pretensao_salarial <span class="op">=</span> pretensao_salarial</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>): <span class="co"># 10</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f&quot;&lt;Caregiver </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>user<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&gt;&quot;</span></span></code></pre></div>
<p><strong>Explicação do app/models/caregiver.py</strong>:</p>
<ol type="1">
<li><code>from app import db</code>: Importa a instância db do
SQLAlchemy.</li>
<li><code>class Caregiver(db.Model)</code>: Define o modelo Caregiver,
que armazena informações profissionais dos cuidadores.</li>
<li><code>__tablename__ = "caregiver"</code>: Nome da tabela no banco de
dados.</li>
<li><strong>Colunas</strong>:
<ul>
<li><code>id</code>: Chave primária.</li>
<li><code>specialty</code>, <code>experience</code>,
<code>education</code>, <code>expertise_area</code>,
<code>skills</code>, <code>rating</code>: Atributos específicos do
perfil profissional do cuidador. O campo skills teve seu tamanho
aumentado para 500 caracteres pela migração
88e77b6b2ef9_aumentar_tamanho_de_textos_em_caregivers.py.</li>
<li><code>dias_disponiveis</code>, <code>periodos_disponiveis</code>,
<code>inicio_imediato</code>, <code>pretensao_salarial</code>:
Informações sobre disponibilidade e pretensão salarial, todos
nullable=True, indicando que são opcionais.</li>
<li><code>nullable=True</code>: Indica que estes campos podem ser
deixados vazios (valor NULO no banco de dados).</li>
</ul></li>
<li><code>user_id = db.Column(db.Integer, db.ForeignKey("users.id"), nullable=False)</code>:
Chave estrangeira que liga o Caregiver ao User. “users.id” refere-se à
coluna id da tabela users. nullable=False significa que todo cuidador
deve estar associado a um usuário.</li>
<li><code>user = db.relationship("User", back_populates="caregiver")</code>:
Define o lado “muitos-para-um” do relacionamento com User. Um Caregiver
está associado a um User. back_populates=“caregiver” liga este
relacionamento ao atributo caregiver no modelo User.</li>
<li><code>contracts = db.relationship("Contract", back_populates="caregiver", cascade="all, delete-orphan")</code>:
Define um relacionamento um-para-muitos com o modelo Contract. Um
cuidador pode ter vários contratos.
<ul>
<li><code>cascade="all, delete-orphan"</code>: Regra de cascata. Se um
Caregiver for deletado, todos os Contract associados a ele também serão
deletados (efeito “delete-orphan”). “all” geralmente cobre operações
como save-update, merge, delete, etc.</li>
</ul></li>
<li><code>def __init__(self, ...)</code>: Construtor para criar
instâncias de Caregiver. Recebe o objeto user associado e os demais
atributos.</li>
<li><code>def __repr__(self)</code>: Representação em string do objeto
Caregiver, útil para depuração. #### app/models/responsible.py</li>
</ol>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># app/models/responsible.py</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app <span class="im">import</span> db <span class="co"># 1</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Responsible(db.Model): <span class="co"># 2</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    __tablename__ <span class="op">=</span> <span class="st">&quot;responsible&quot;</span> <span class="co"># 3</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> db.Column(db.Integer, primary_key<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    user_id <span class="op">=</span> db.Column(db.Integer, db.ForeignKey(<span class="st">&quot;users.id&quot;</span>), nullable<span class="op">=</span><span class="va">False</span>) <span class="co"># 4</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    user <span class="op">=</span> db.relationship(<span class="st">&quot;User&quot;</span>, back_populates<span class="op">=</span><span class="st">&quot;responsible&quot;</span>) <span class="co"># 5</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    elderly <span class="op">=</span> db.relationship(<span class="st">&quot;Elderly&quot;</span>, back_populates<span class="op">=</span><span class="st">&quot;responsible&quot;</span>, cascade<span class="op">=</span><span class="st">&quot;all, delete-orphan&quot;</span>) <span class="co"># 6</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    contracts <span class="op">=</span> db.relationship(<span class="st">&quot;Contract&quot;</span>, back_populates<span class="op">=</span><span class="st">&quot;responsible&quot;</span>, cascade<span class="op">=</span><span class="st">&quot;all, delete-orphan&quot;</span>) <span class="co"># 7</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    relationship_with_elderly <span class="op">=</span> db.Column(db.String(<span class="dv">50</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    primary_need_description <span class="op">=</span> db.Column(db.String(<span class="dv">255</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    preferred_contact_method <span class="op">=</span> db.Column(db.String(<span class="dv">30</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, user, relationship_with_elderly<span class="op">=</span><span class="va">None</span>, primary_need_description<span class="op">=</span><span class="va">None</span>, preferred_contact_method<span class="op">=</span><span class="va">None</span>): <span class="co"># 8</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.user <span class="op">=</span> user</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.relationship_with_elderly <span class="op">=</span> relationship_with_elderly</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.primary_need_description <span class="op">=</span> primary_need_description</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.preferred_contact_method <span class="op">=</span> preferred_contact_method</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>): <span class="co"># 9</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f&quot;&lt;Responsible </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>user<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&gt;&quot;</span></span></code></pre></div>
<p><strong>Explicação do app/models/responsible.py</strong>:</p>
<ol type="1">
<li><code>from app import db</code>: Importa a instância db do
SQLAlchemy.</li>
<li><code>class Responsible(db.Model)</code>: Define o modelo
Responsible, que armazena informações dos responsáveis por idosos.</li>
<li><code>__tablename__ = "responsible"</code>: Nome da tabela no banco
de dados.</li>
<li><code>user_id = db.Column(db.Integer, db.ForeignKey("users.id"), nullable=False)</code>:
Chave estrangeira para o modelo User. Todo responsável deve ser um
usuário.</li>
<li><code>user = db.relationship("User", back_populates="responsible")</code>:
Relacionamento com User (lado “muitos-para-um”).</li>
<li><code>elderly = db.relationship("Elderly", back_populates="responsible", cascade="all, delete-orphan")</code>:
Relacionamento um-para-muitos com Elderly. Um responsável pode ter
vários idosos associados. A cascata all, delete-orphan significa que se
um responsável for excluído, todos os idosos vinculados a ele também
serão.</li>
<li><code>contracts = db.relationship("Contract", back_populates="responsible", cascade="all, delete-orphan")</code>:
Relacionamento um-para-muitos com Contract. Um responsável pode ter
vários contratos. A cascata funciona da mesma forma.</li>
<li><code>def __init__(self, ...)</code>: Construtor para criar
instâncias de Responsible.</li>
<li><code>def __repr__(self)</code>: Representação em string do objeto
Responsible.</li>
</ol>
<h4 id="appmodelselderly.py">app/models/elderly.py</h4>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># app/models/elderly.py</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date <span class="co"># 1</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app <span class="im">import</span> db <span class="co"># 2</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Elderly(db.Model): <span class="co"># 3</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    __tablename__ <span class="op">=</span> <span class="st">&quot;elderly&quot;</span> <span class="co"># 4</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> db.Column(db.Integer, primary_key<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    cpf <span class="op">=</span> db.Column(db.String(<span class="dv">20</span>), nullable<span class="op">=</span><span class="va">True</span>) <span class="co"># CPF opcional</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    birthdate <span class="op">=</span> db.Column(db.Date, nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    gender <span class="op">=</span> db.Column(db.String(<span class="dv">10</span>), nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    address_elderly <span class="op">=</span> db.Column(db.String(<span class="dv">255</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    city_elderly <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    state_elderly <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    photo_url <span class="op">=</span> db.Column(db.String(<span class="dv">255</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    medical_conditions <span class="op">=</span> db.Column(db.Text, nullable<span class="op">=</span><span class="va">True</span>) <span class="co"># Usando db.Text para campos mais longos</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    allergies <span class="op">=</span> db.Column(db.Text, nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    medications_in_use <span class="op">=</span> db.Column(db.Text, nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    mobility_level <span class="op">=</span> db.Column(db.String(<span class="dv">40</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    specific_care_needs <span class="op">=</span> db.Column(db.Text, nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    emergency_contact_name <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    emergency_contact_phone <span class="op">=</span> db.Column(db.String(<span class="dv">30</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    emergency_contact_relationship <span class="op">=</span> db.Column(db.String(<span class="dv">50</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    health_plan_name <span class="op">=</span> db.Column(db.String(<span class="dv">100</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    health_plan_number <span class="op">=</span> db.Column(db.String(<span class="dv">50</span>), nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    additional_notes <span class="op">=</span> db.Column(db.Text, nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Chave estrangeira para o responsável</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    responsible_id <span class="op">=</span> db.Column(db.Integer, db.ForeignKey(<span class="st">&quot;responsible.id&quot;</span>), nullable<span class="op">=</span><span class="va">False</span>) <span class="co"># 5</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Relações</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    responsible <span class="op">=</span> db.relationship(<span class="st">&quot;Responsible&quot;</span>, back_populates<span class="op">=</span><span class="st">&quot;elderly&quot;</span>) <span class="co"># 6</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name, birthdate, gender, responsible, cpf<span class="op">=</span><span class="va">None</span>, address_elderly<span class="op">=</span><span class="va">None</span>, city_elderly<span class="op">=</span><span class="va">None</span>, state_elderly<span class="op">=</span><span class="va">None</span>, photo_url<span class="op">=</span><span class="va">None</span>, medical_conditions<span class="op">=</span><span class="va">None</span>, allergies<span class="op">=</span><span class="va">None</span>, medications_in_use<span class="op">=</span><span class="va">None</span>, mobility_level<span class="op">=</span><span class="va">None</span>, specific_care_needs<span class="op">=</span><span class="va">None</span>, emergency_contact_name<span class="op">=</span><span class="va">None</span>, emergency_contact_phone<span class="op">=</span><span class="va">None</span>, emergency_contact_relationship<span class="op">=</span><span class="va">None</span>, health_plan_name<span class="op">=</span><span class="va">None</span>, health_plan_number<span class="op">=</span><span class="va">None</span>, additional_notes<span class="op">=</span><span class="va">None</span>): <span class="co"># 7</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cpf <span class="op">=</span> cpf</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... (atribuição de todos os outros campos) ...</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.responsible <span class="op">=</span> responsible <span class="co"># Atribui o objeto Responsible diretamente</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>): <span class="co"># 8</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f&quot;&lt;Elderly </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>name<span class="sc">}</span><span class="ss">&gt;&quot;</span></span></code></pre></div>
<p><strong>Explicação do app/models/elderly.py</strong>:</p>
<ol type="1">
<li><code>from datetime import date</code>: Importa o tipo date para o
campo birthdate.</li>
<li><code>from app import db</code>: Importa a instância db.</li>
<li><code>class Elderly(db.Model)</code>: Define o modelo Elderly para
informações detalhadas sobre os idosos.</li>
<li><code>__tablename__ = "elderly"</code>: Nome da tabela.</li>
<li><code>responsible_id = db.Column(db.Integer, db.ForeignKey("responsible.id"), nullable=False)</code>:
Chave estrangeira para Responsible. Todo idoso deve estar associado a um
responsável.</li>
<li><code>responsible = db.relationship("Responsible", back_populates="elderly")</code>:
Relacionamento com Responsible (lado “muitos-para-um”).</li>
<li><code>def __init__(self, ...)</code>: Construtor. Note que ele
recebe o objeto responsible diretamente, o que é uma forma comum de
estabelecer o relacionamento ao criar um novo Elderly.</li>
<li><code>def __repr__(self)</code>: Representação em string. ####
app/models/contract.py</li>
</ol>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># app/models/contract.py</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime <span class="co"># 1</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app <span class="im">import</span> db <span class="co"># 2</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Contract(db.Model): <span class="co"># 3</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    __tablename__ <span class="op">=</span> <span class="st">&quot;contract&quot;</span> <span class="co"># 4</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> db.Column(db.Integer, primary_key<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    start_date <span class="op">=</span> db.Column(db.DateTime, nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    end_date <span class="op">=</span> db.Column(db.DateTime, nullable<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Chaves estrangeiras</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    responsible_id <span class="op">=</span> db.Column(db.Integer, db.ForeignKey(<span class="st">&quot;responsible.id&quot;</span>), nullable<span class="op">=</span><span class="va">False</span>) <span class="co"># 5</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    caregiver_id <span class="op">=</span> db.Column(db.Integer, db.ForeignKey(<span class="st">&quot;caregiver.id&quot;</span>), nullable<span class="op">=</span><span class="va">False</span>) <span class="co"># 6</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Relações</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    responsible <span class="op">=</span> db.relationship(<span class="st">&quot;Responsible&quot;</span>, back_populates<span class="op">=</span><span class="st">&quot;contracts&quot;</span>) <span class="co"># 7</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    caregiver <span class="op">=</span> db.relationship(<span class="st">&quot;Caregiver&quot;</span>, back_populates<span class="op">=</span><span class="st">&quot;contracts&quot;</span>) <span class="co"># 8</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, responsible, caregiver, start_date<span class="op">=</span><span class="va">None</span>, end_date<span class="op">=</span><span class="va">None</span>): <span class="co"># 9</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.responsible <span class="op">=</span> responsible</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.caregiver <span class="op">=</span> caregiver</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.start_date <span class="op">=</span> start_date <span class="kw">or</span> datetime.utcnow() <span class="co"># 10</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.end_date <span class="op">=</span> end_date</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>): <span class="co"># 11</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f&quot;&lt;Contract </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>caregiver<span class="sc">.</span>user<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>responsible<span class="sc">.</span>user<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&gt;&quot;</span></span></code></pre></div>
<p><strong>Explicação do app/models/contract.py</strong>:</p>
<ol type="1">
<li><code>from datetime import datetime</code>: Importa datetime para as
datas de início e fim do contrato.</li>
<li><code>from app import db</code>: Importa a instância db.</li>
<li><code>class Contract(db.Model)</code>: Define o modelo Contract para
armazenar informações sobre contratos.</li>
<li><code>__tablename__ = "contract"</code>: Nome da tabela.</li>
<li><code>responsible_id = db.Column(db.Integer, db.ForeignKey("responsible.id"), nullable=False)</code>:
Chave estrangeira para Responsible.</li>
<li><code>caregiver_id = db.Column(db.Integer, db.ForeignKey("caregiver.id"), nullable=False)</code>:
Chave estrangeira para Caregiver.</li>
<li><code>responsible = db.relationship("Responsible", back_populates="contracts")</code>:
Relacionamento com Responsible (lado “muitos-para-um”).</li>
<li><code>caregiver = db.relationship("Caregiver", back_populates="contracts")</code>:
Relacionamento com Caregiver (lado “muitos-para-um”).</li>
<li><code>def __init__(self, ...)</code>: Construtor.</li>
<li><code>self.start_date = start_date or datetime.utcnow()</code>: Se
start_date não for fornecida, usa a data e hora UTC atuais como
padrão.</li>
<li><code>def __repr__(self)</code>: Representação em string, mostrando
o ID do contrato e os nomes do cuidador e do responsável.</li>
</ol>
<p><strong>Diagrama ER (Entidade-Relacionamento) do
README.md:</strong></p>
<p>O README.md inclui um diagrama ER que visualiza bem esses
relacionamentos:</p>
<pre class="text"><code>+-------------+       +---------------+       +-------------+
|    User     |       |   Caregiver   |       |  Contract   |
+-------------+       +---------------+       +-------------+
| id          |&lt;-----&gt;| id            |&lt;-----&gt;| id          |
| name        |       | user_id (FK)  |       | caregiver_id(FK)|
...           |       ...             |       | responsible_id(FK)|
+-------------+       +---------------+       ...
      ^                      ^                +-------------+
      | (user_id)            | (user_id)
      |                      |
+-------------+       +-------------+
| Responsible |       |   Elderly   |
+-------------+       +-------------+
| id          |&lt;-----&gt;| id          |
| user_id (FK)|       | name        |
...           |       | responsible_id(FK)|
+-------------+       ...
                      +-------------+</code></pre>
<p>Pequena correção na interpretação do diagrama do README em relação às
chaves:</p>
<p>User tem um relacionamento 1-para-1 (ou 0) com Caregiver (User -&gt;
Caregiver) e 1-para-1 (ou 0) com Responsible (User -&gt; Responsible). A
FK user_id está em Caregiver e Responsible. Responsible tem um
relacionamento 1-para-N com Elderly (Responsible -&gt; Elderly). A FK
responsible_id está em Elderly. Contract tem um relacionamento N-para-1
com Caregiver (Contract -&gt; Caregiver) e N-para-1 com Responsible
(Contract -&gt; Responsible). As FKs caregiver_id e responsible_id estão
em Contract. Os modelos de dados estão bem estruturados e os
relacionamentos parecem corretos para a lógica de negócios descrita.</p>
<h3 id="rotas-e-controladores-approutes">5.3. Rotas e Controladores
(app/routes/)</h3>
<p>As rotas definem os URLs da sua aplicação e as funções
(controladores) que são executadas quando esses URLs são acessados. Elas
usam Blueprints para organização.</p>
<h4 id="approutesinit.py">app/routes/<strong>init</strong>.py</h4>
<p>Este arquivo geralmente está vazio ou é usado para importar os
Blueprints, mas no seu caso, as importações dos blueprints são feitas
diretamente em app/<strong>init</strong>.py para registro.</p>
<h4 id="approuteshome.py">app/routes/home.py</h4>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Blueprint, render_template, session <span class="co"># 1</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>home_bp <span class="op">=</span> Blueprint(<span class="st">&quot;home&quot;</span>, <span class="va">__name__</span>, url_prefix<span class="op">=</span><span class="st">&quot;/&quot;</span>) <span class="co"># 2</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="at">@home_bp.route</span>(<span class="st">&quot;/&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>]) <span class="co"># 3</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> home(): <span class="co"># 4</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Home page.</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;home/home.html&quot;</span>) <span class="co"># 5</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="at">@home_bp.route</span>(<span class="st">&quot;/logout&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>]) <span class="co"># 6</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> logout():</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    session.pop(<span class="st">&#39;user_id&#39;</span>, <span class="va">None</span>) <span class="co"># 7</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Deveria haver um redirect aqui, por exemplo, para a página inicial ou de login.</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Atualmente, renderiza home.html, mas o estado da sessão mudou.</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># O README indica que a rota de logout está em login_bp, o que é mais comum.</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Esta rota /logout aqui pode ser um resquício ou uma alternativa.</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># O navbar_login.html aponta para &#39;home.logout&#39;</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># O login.py também tem uma rota /logout que redireciona</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;home/home.html&quot;</span>) <span class="co"># 8</span></span></code></pre></div>
<p><strong>Explicação do app/routes/home.py</strong>:</p>
<ol type="1">
<li><strong>Importações</strong>:
<ul>
<li><code>from flask import Blueprint, render_template, session</code>:
Importações necessárias do Flask.</li>
<li><code>Blueprint</code>: Para criar o blueprint.</li>
<li><code>render_template</code>: Para renderizar arquivos HTML.</li>
<li><code>session</code>: Para interagir com a sessão do usuário (ex:
para logout).</li>
</ul></li>
<li><code>home_bp = Blueprint("home", __name__, url_prefix="/")</code>:
Cria um Blueprint chamado “home”.
<ul>
<li><code>"home"</code>: Nome do blueprint.</li>
<li><code>__name__</code>: O nome do módulo, usado pelo Flask.</li>
<li><code>url_prefix="/"</code>: Todas as rotas definidas neste
blueprint terão “/” como prefixo (neste caso, sem prefixo adicional,
pois já é a raiz).</li>
</ul></li>
<li><code>@home_bp.route("/", methods=["GET"])</code>: Define uma rota
para a URL raiz (/) que aceita apenas requisições HTTP GET.</li>
<li><code>def home()</code>: A função controladora para a rota /.</li>
<li><code>return render_template("home/home.html")</code>: Renderiza o
template home/home.html e o retorna como resposta.</li>
<li><code>@home_bp.route("/logout", methods=["GET"])</code>: Define uma
rota /logout.</li>
<li><code>session.pop('user_id', None)</code>: Remove user_id da sessão,
efetivamente deslogando o usuário. None como segundo argumento evita um
erro se user_id não estiver na sessão.</li>
<li><code>return render_template("home/home.html")</code>: Renderiza a
página inicial após o logout. Idealmente, deveria haver um flash message
informando sobre o logout e um redirect(url_for(‘home.home’)).</li>
</ol>
<p><strong>Ponto de atenção</strong>: Existe uma rota /login/logout em
login.py que parece ser a principal para logout e faz um redirect. Ter
duas rotas de logout pode ser confuso. O template navbar_login.html usa
url_for(‘home.logout’). É preciso consolidar ou garantir que ambas
funcionem como esperado. O README.md menciona /login/logout.</p>
<h4 id="approuteslogin.py">app/routes/login.py</h4>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># app/routes/login.py</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Blueprint, render_template, request, redirect, url_for, session, flash <span class="co"># 1</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.services <span class="im">import</span> caregiver_service, responsible_service, user_service <span class="co"># 2</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>login_bp <span class="op">=</span> Blueprint(<span class="st">&quot;login&quot;</span>, <span class="va">__name__</span>, url_prefix<span class="op">=</span><span class="st">&quot;/login&quot;</span>) <span class="co"># 3</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="at">@login_bp.route</span>(<span class="st">&quot;/&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>, <span class="st">&quot;POST&quot;</span>]) <span class="co"># 4</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> login(): <span class="co"># 5</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&#39;user_id&#39;</span> <span class="kw">in</span> session: <span class="co"># 6</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;home.home&#39;</span>))</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">&quot;POST&quot;</span>: <span class="co"># 7</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>        email <span class="op">=</span> request.form.get(<span class="st">&#39;email&#39;</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        password <span class="op">=</span> request.form.get(<span class="st">&#39;password&#39;</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> email <span class="kw">or</span> <span class="kw">not</span> password: <span class="co"># 8</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>            flash(<span class="st">&#39;Email e senha são obrigatórios&#39;</span>, <span class="st">&#39;warning&#39;</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">&#39;login.login&#39;</span>))</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> user_service.get_by_email(email) <span class="co"># 9</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># A verificação da senha (user.check_password(password)) está faltando aqui!</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Isso é uma falha de segurança crítica.</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> user: <span class="co"># Ou se a senha não conferir (deveria ser &#39;if not user or not user.check_password(password):&#39;)</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>            flash(<span class="st">&#39;Email ou senha inválidos&#39;</span>, <span class="st">&#39;danger&#39;</span>)</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">&#39;login.login&#39;</span>))</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Lógica de verificação de senha corrigida (sugestão):</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if not user or not user.check_password(password):</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     flash(&#39;Email ou senha inválidos&#39;, &#39;danger&#39;)</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     return redirect(url_for(&#39;login.login&#39;))</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># O código abaixo assume que o usuário foi autenticado com sucesso</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        caregiver <span class="op">=</span> caregiver_service.get_caregiver_by_id(user.<span class="bu">id</span>) <span class="co"># 10</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> caregiver:</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>            caregiver <span class="op">=</span> caregiver_service.get_caregiver_by_email(user.email)</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        responsible <span class="op">=</span> responsible_service.get_responsible_by_id(user.<span class="bu">id</span>)</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> responsible:</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>            responsible <span class="op">=</span> responsible_service.get_responsible_by_email(user.email)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        session[<span class="st">&#39;user_id&#39;</span>] <span class="op">=</span> user.<span class="bu">id</span> <span class="co"># 11</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> caregiver <span class="kw">and</span> <span class="kw">not</span> responsible: <span class="co"># 12</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>            session[<span class="st">&#39;acting_profile&#39;</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>            flash(<span class="st">&#39;Você ainda não possui um perfil de Cuidador ou Responsável. Por favor, crie um.&#39;</span>, <span class="st">&#39;info&#39;</span>)</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">&#39;register.select_profile&#39;</span>))</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> caregiver <span class="kw">and</span> responsible: <span class="co"># 13</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">&#39;login.select_acting_profile&#39;</span>))</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> caregiver: <span class="co"># 14</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>            session[<span class="st">&#39;acting_profile&#39;</span>] <span class="op">=</span> <span class="st">&#39;caregiver&#39;</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> responsible: <span class="co"># 15</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>            session[<span class="st">&#39;acting_profile&#39;</span>] <span class="op">=</span> <span class="st">&#39;responsible&#39;</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>: <span class="co"># 16 - Este caso já foi tratado acima, mas por segurança.</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>            session[<span class="st">&#39;acting_profile&#39;</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Poderia redirecionar para select_profile também.</span></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>        flash(<span class="st">&#39;Login realizado com sucesso&#39;</span>, <span class="st">&#39;success&#39;</span>)</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;home.home&#39;</span>)) <span class="co"># 17</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;login/login.html&quot;</span>) <span class="co"># 18</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a><span class="at">@login_bp.route</span>(<span class="st">&quot;/select-acting-profile&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>, <span class="st">&quot;POST&quot;</span>]) <span class="co"># 19</span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> select_acting_profile(): <span class="co"># 20</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    user_id <span class="op">=</span> session.get(<span class="st">&#39;user_id&#39;</span>)</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> user_id: <span class="co"># 21</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;login.login&#39;</span>))</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    user <span class="op">=</span> user_service.get_by_id(user_id)</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># A busca por caregiver e responsible é um pouco redundante, poderia ser simplificada</span></span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># usando os relacionamentos do objeto &#39;user&#39; (user.caregiver, user.responsible)</span></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ex: has_caregiver = bool(user.caregiver)</span></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ex: has_responsible = bool(user.responsible)</span></span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>    caregiver <span class="op">=</span> caregiver_service.get_caregiver_by_id(user_id) <span class="cf">if</span> user <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> caregiver <span class="kw">and</span> user:</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>        caregiver <span class="op">=</span> caregiver_service.get_caregiver_by_email(user.email) <span class="co"># busca por email se por ID não encontrar</span></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>    responsible <span class="op">=</span> responsible_service.get_responsible_by_id(user_id) <span class="cf">if</span> user <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> responsible <span class="kw">and</span> user:</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>        responsible <span class="op">=</span> responsible_service.get_responsible_by_email(user.email) <span class="co"># busca por email se por ID não encontrar</span></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">&quot;POST&quot;</span>: <span class="co"># 22</span></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>        profile <span class="op">=</span> request.form.get(<span class="st">&#39;acting_profile&#39;</span>)</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> profile <span class="op">==</span> <span class="st">&#39;caregiver&#39;</span>:</span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> caregiver:</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>                session[<span class="st">&#39;acting_profile&#39;</span>] <span class="op">=</span> <span class="st">&#39;caregiver&#39;</span></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>                flash(<span class="st">&#39;Você está atuando como Cuidador.&#39;</span>, <span class="st">&#39;success&#39;</span>)</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> redirect(url_for(<span class="st">&#39;home.home&#39;</span>))</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>: <span class="co"># Se tentou selecionar cuidador mas não tem esse perfil</span></span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>                flash(<span class="st">&#39;Você não possui um perfil de Cuidador. Crie um primeiro.&#39;</span>, <span class="st">&#39;warning&#39;</span>)</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> redirect(url_for(<span class="st">&#39;register.register_caregiver&#39;</span>))</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> profile <span class="op">==</span> <span class="st">&#39;responsible&#39;</span>:</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> responsible:</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>                session[<span class="st">&#39;acting_profile&#39;</span>] <span class="op">=</span> <span class="st">&#39;responsible&#39;</span></span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>                flash(<span class="st">&#39;Você está atuando como Responsável.&#39;</span>, <span class="st">&#39;success&#39;</span>)</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> redirect(url_for(<span class="st">&#39;home.home&#39;</span>))</span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>: <span class="co"># Se tentou selecionar responsável mas não tem esse perfil</span></span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>                flash(<span class="st">&#39;Você não possui um perfil de Responsável. Crie um primeiro.&#39;</span>, <span class="st">&#39;warning&#39;</span>)</span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> redirect(url_for(<span class="st">&#39;register.register_responsible&#39;</span>))</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>            flash(<span class="st">&#39;Selecione um perfil válido.&#39;</span>, <span class="st">&#39;warning&#39;</span>)</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template( <span class="co"># 23</span></span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;login/select_acting_profile.html&quot;</span>,</span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>        has_caregiver<span class="op">=</span><span class="bu">bool</span>(caregiver),</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>        has_responsible<span class="op">=</span><span class="bu">bool</span>(responsible)</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a><span class="at">@login_bp.route</span>(<span class="st">&quot;/logout&quot;</span>) <span class="co"># 24</span></span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> logout():</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>    session.pop(<span class="st">&#39;user_id&#39;</span>, <span class="va">None</span>)</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a>    session.pop(<span class="st">&#39;acting_profile&#39;</span>, <span class="va">None</span>) <span class="co"># É bom limpar o perfil ativo também</span></span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>    flash(<span class="st">&#39;Você saiu da sua conta.&#39;</span>, <span class="st">&#39;info&#39;</span>) <span class="co"># Adicionar feedback</span></span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> redirect(url_for(<span class="st">&#39;home.home&#39;</span>)) <span class="co"># 25</span></span></code></pre></div>
<p><strong>Explicação do app/routes/login.py</strong>:</p>
<ol type="1">
<li><p><strong>Importações</strong>:</p>
<ul>
<li><code>Blueprint, render_template, request</code> (para acessar dados
de formulários), <code>redirect, url_for</code> (para construir URLs
para outras rotas), <code>session, flash</code> (para mensagens ao
usuário).</li>
<li><code>from app.services import ...</code>: Importa os serviços
necessários para interagir com a lógica de negócios e o banco de
dados.</li>
</ul></li>
<li><p><code>login_bp = Blueprint("login", __name__, url_prefix="/login")</code>:
Cria o blueprint “login” com prefixo de URL /login.</p></li>
<li><p><code>@login_bp.route("/", methods=["GET", "POST"])</code>: Rota
para a página de login, acessível via /login/. Aceita GET (para exibir o
formulário) e POST (para processar os dados do formulário).</p></li>
<li><p><code>def login()</code>: Função controladora do login.</p></li>
<li><p><code>if 'user_id' in session</code>: Se o usuário já estiver
logado (tem user_id na sessão), redireciona para a home.</p></li>
<li><p><code>if request.method == "POST"</code>: Se a requisição for
POST (envio do formulário).</p></li>
<li><p><strong>Validação de Formulário</strong>: Verifica se email e
senha foram enviados. Se não, exibe uma mensagem flash e redireciona de
volta para a página de login.</p></li>
<li><p><code>user = user_service.get_by_email(email)</code>: Busca o
usuário pelo email.</p></li>
<li><p><strong>FALHA DE SEGURANÇA CRÍTICA</strong>: O código não
verifica a senha do usuário! Ele apenas verifica se o email existe. Um
invasor poderia logar em qualquer conta apenas sabendo o email. É
ESSENCIAL adicionar
<code>if not user or not user.check_password(password):</code>
aqui.</p></li>
<li><p><strong>Busca de Perfis</strong>: Após (supostamente) autenticar
o usuário, o código busca se ele tem um perfil de Caregiver ou
Responsible. A busca por ID e depois por email parece um pouco
redundante. Se user.id é o ID do usuário, e os perfis Caregiver e
Responsible têm um campo user_id que é uma FK para users.id, então
caregiver_service.get_caregiver_by_id(user.id) deveria ser suficiente
(ou, melhor ainda, usar user.caregiver se o relacionamento estiver
carregado). A busca por email aqui (get_caregiver_by_email) pode ser um
fallback desnecessário ou indicar uma inconsistência em como os IDs são
tratados.</p></li>
<li><p><code>session['user_id'] = user.id</code>: Armazena o ID do
usuário na sessão, marcando-o como logado.</p></li>
<li><p><strong>Sem Perfis</strong>: Se o usuário logado não tem perfil
de Cuidador nem de Responsável, ele é redirecionado para a página de
seleção de perfil (/register/select-profile) para criar um.</p></li>
<li><p><strong>Ambos os Perfis</strong>: Se o usuário tem ambos os
perfis, ele é redirecionado para /login/select-acting-profile para
escolher com qual perfil deseja atuar na sessão atual.</p></li>
<li><p><strong>Perfil de Cuidador</strong>: Se tem apenas o perfil de
Cuidador, define session[‘acting_profile’] = ‘caregiver’.</p></li>
<li><p><strong>Perfil de Responsável</strong>: Se tem apenas o perfil de
Responsável, define session[‘acting_profile’] = ‘responsible’.</p></li>
<li><p><strong>Caso Else</strong>: Teoricamente, este else não deveria
ser alcançado se a lógica anterior for completa.</p></li>
<li><p><code>return redirect(url_for('home.home'))</code>: Redireciona
para a página inicial após o login bem-sucedido.</p></li>
<li><p><code>return render_template("login/login.html")</code>: Se a
requisição for GET, exibe o formulário de login.</p></li>
<li><p><code>@login_bp.route("/select-acting-profile", methods=["GET", "POST"])</code>:
Rota para /login/select-acting-profile, onde usuários com múltiplos
perfis escolhem qual usar.</p></li>
<li><p><code>def select_acting_profile()</code>: Função controladora
para seleção de perfil de atuação.</p></li>
<li><p><strong>Verificação de Sessão</strong>: Garante que apenas
usuários logados acessem esta página.</p></li>
<li><p><code>if request.method == "POST"</code>: Processa a escolha do
perfil. Define session[‘acting_profile’] e redireciona para a home. Se o
usuário tentar selecionar um perfil que não possui (o que não deveria
ser possível pela UI, mas é uma boa checagem de backend), ele é
redirecionado para a página de registro do respectivo perfil.</p></li>
<li><p><code>return render_template(...)</code>: Se GET, exibe a página
de seleção de perfil de atuação, passando flags has_caregiver e
has_responsible para o template
login/select_acting_profile.html.</p></li>
<li><p><code>@login_bp.route("/logout")</code>: Rota para /login/logout.
Esta é a rota de logout referenciada no README.md.</p></li>
<li><p><code>return redirect(url_for('home.home'))</code>: Desloga o
usuário (removendo user_id da sessão) e redireciona para a home. Seria
bom adicionar session.pop(‘acting_profile’, None) e uma mensagem flash
aqui também.</p></li>
</ol>
<h4
id="approutesregister.py"><strong>app/routes/register.py</strong></h4>
<p>Este arquivo lida com todo o fluxo de registro de novos usuários e a
criação de seus perfis (Cuidador, Responsável, Idoso).</p>
<p><strong>Importações e configuração do Blueprint:</strong></p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># app/routes/register.py</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Blueprint, render_template, request, redirect, url_for, session, flash  <span class="co"># 1</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.user <span class="im">import</span> User  <span class="co"># 2</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.caregiver <span class="im">import</span> Caregiver</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.responsible <span class="im">import</span> Responsible</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.elderly <span class="im">import</span> Elderly</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.services <span class="im">import</span> user_service, caregiver_service, responsible_service, elderly_service  <span class="co"># 3</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime  <span class="co"># 4</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>register_bp <span class="op">=</span> Blueprint(<span class="st">&quot;register&quot;</span>, <span class="va">__name__</span>, url_prefix<span class="op">=</span><span class="st">&quot;/register&quot;</span>)  <span class="co"># 5</span></span></code></pre></div>
<p><strong>Rota principal de registro de usuário:</strong></p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="at">@register_bp.route</span>(<span class="st">&quot;/&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>, <span class="st">&quot;POST&quot;</span>])  <span class="co"># 6</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> register():  <span class="co"># 7</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&#39;user_id&#39;</span> <span class="kw">in</span> session:  <span class="co"># Se já logado, redireciona para home</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;home.home&#39;</span>))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">&quot;POST&quot;</span>:  <span class="co"># 8</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Coleta de dados do formulário</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>            name <span class="op">=</span> request.form.get(<span class="st">&#39;name&#39;</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ... (coleta de todos os outros campos do formulário de usuário) ...</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>            birthdate_str <span class="op">=</span> request.form.get(<span class="st">&#39;birthdate&#39;</span>)  <span class="co"># Data vem como string</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>            <span class="co"># É importante converter birthdate para objeto date aqui antes de passar para User</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Ex: birthdate = datetime.strptime(birthdate_str, &#39;%Y-%m-%d&#39;).date() if birthdate_str else None</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verifica se o usuário já existe</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>            existing_user <span class="op">=</span> user_service.get_by_email_or_phone_or_cpf(email<span class="op">=</span>email, phone<span class="op">=</span>phone, cpf<span class="op">=</span>cpf)  <span class="co"># 9</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> existing_user:</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>                flash(<span class="st">&#39;Usuário já cadastrado com um desses dados (email, telefone ou CPF).&#39;</span>, <span class="st">&#39;danger&#39;</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> redirect(url_for(<span class="st">&#39;register.register&#39;</span>))</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Criação e salvamento do usuário</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Certifique-se de que &#39;birthdate&#39; seja um objeto date</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>            user <span class="op">=</span> User( </span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>                name<span class="op">=</span>name, cpf<span class="op">=</span>cpf, phone<span class="op">=</span>phone, email<span class="op">=</span>email, password<span class="op">=</span>password,</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>                address<span class="op">=</span>address, city<span class="op">=</span>city, state<span class="op">=</span>state, </span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>                birthdate<span class="op">=</span>datetime.strptime(birthdate, <span class="st">&#39;%Y-%m-</span><span class="sc">%d</span><span class="st">&#39;</span>).date() <span class="cf">if</span> birthdate <span class="cf">else</span> <span class="va">None</span>,  <span class="co"># Conversão</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>                gender<span class="op">=</span>gender</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>            user_service.save(user)  <span class="co"># 10</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>            session[<span class="st">&#39;user_id&#39;</span>] <span class="op">=</span> user.<span class="bu">id</span>  <span class="co"># 11</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>            flash(<span class="st">&#39;Usuário cadastrado com sucesso! Agora, por favor, crie seu perfil.&#39;</span>, <span class="st">&#39;success&#39;</span>)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">&#39;register.select_profile&#39;</span>))  <span class="co"># 12</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">ValueError</span> <span class="im">as</span> e:  <span class="co"># 13 - Ex: erro de conversão de data</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>            flash(<span class="bu">str</span>(e), <span class="st">&#39;danger&#39;</span>)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:  <span class="co"># 14 - Captura genérica de erros</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>            flash(<span class="st">&#39;Ocorreu um erro ao cadastrar o usuário. Tente novamente.&#39;</span>, <span class="st">&#39;danger&#39;</span>)</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Logar o erro &#39;e&#39; aqui seria útil para depuração no servidor</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">&#39;register.register&#39;</span>))</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;register/register.html&quot;</span>)  <span class="co"># 15</span></span></code></pre></div>
<p><strong>Rotas de seleção de perfil:</strong></p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="at">@register_bp.route</span>(<span class="st">&quot;/select-profile&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>])  <span class="co"># 16</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> select_profile():  <span class="co"># 17</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    user_id <span class="op">=</span> session.get(<span class="st">&#39;user_id&#39;</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> user_id:  <span class="co"># Protege a rota</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;login.login&#39;</span>))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    user <span class="op">=</span> user_service.get_by_id(user_id)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> user:</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        flash(<span class="st">&#39;Usuário não encontrado&#39;</span>, <span class="st">&#39;danger&#39;</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;login.login&#39;</span>))</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;register/select.html&quot;</span>, user<span class="op">=</span>user)  <span class="co"># 18</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="at">@register_bp.route</span>(<span class="st">&quot;/add-profile&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>, <span class="st">&quot;POST&quot;</span>])  <span class="co"># 19</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_profile():  <span class="co"># 20</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lógica similar à select_acting_profile para verificar perfis existentes</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># e redirecionar para o cadastro do perfil faltante.</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    user_id <span class="op">=</span> session.get(<span class="st">&#39;user_id&#39;</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> user_id:</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;login.login&#39;</span>))</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    user <span class="op">=</span> user_service.get_by_id(user_id)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Novamente, usar user.caregiver e user.responsible seria mais direto</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    caregiver <span class="op">=</span> caregiver_service.get_caregiver_by_id(user_id) <span class="cf">if</span> user <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> caregiver <span class="kw">and</span> user: </span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        caregiver <span class="op">=</span> caregiver_service.get_caregiver_by_email(user.email)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    responsible <span class="op">=</span> responsible_service.get_responsible_by_id(user_id) <span class="cf">if</span> user <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> responsible <span class="kw">and</span> user: </span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        responsible <span class="op">=</span> responsible_service.get_responsible_by_email(user.email)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">&quot;POST&quot;</span>:</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> caregiver <span class="kw">and</span> request.form.get(<span class="st">&#39;add_caregiver&#39;</span>):  <span class="co"># Se não tem cuidador E marcou para adicionar cuidador</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">&#39;register.register_caregiver&#39;</span>))</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> responsible <span class="kw">and</span> request.form.get(<span class="st">&#39;add_responsible&#39;</span>):  <span class="co"># Se não tem responsável E marcou para adicionar responsável</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">&#39;register.register_responsible&#39;</span>))</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        flash(<span class="st">&#39;Selecione um perfil para adicionar ou você já possui ambos.&#39;</span>, <span class="st">&#39;warning&#39;</span>)  <span class="co"># Mensagem pode ser melhorada</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># O template &quot;profile/select.html&quot; não foi fornecido, mas o README menciona.</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assume-se que ele mostra opções para adicionar perfis faltantes.</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;profile/select.html&quot;</span>,  <span class="co"># Este template não foi fornecido nos arquivos.</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>        user<span class="op">=</span>user,</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>        show_add_profile<span class="op">=</span><span class="va">True</span>,  <span class="co"># Flag para o template saber o contexto</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>        has_caregiver<span class="op">=</span><span class="bu">bool</span>(caregiver),</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>        has_responsible<span class="op">=</span><span class="bu">bool</span>(responsible)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<p><strong>Rota de registro de cuidador:</strong></p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="at">@register_bp.route</span>(<span class="st">&#39;/caregiver&#39;</span>, methods<span class="op">=</span>[<span class="st">&#39;GET&#39;</span>, <span class="st">&#39;POST&#39;</span>]) <span class="co"># 21</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> register_caregiver(): <span class="co"># 22</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">&quot;POST&quot;</span>:</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        user_id <span class="op">=</span> session.get(<span class="st">&#39;user_id&#39;</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> user_id: <span class="co"># Protege a rota</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">&#39;login.login&#39;</span>))</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> user_service.get_by_id(user_id)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Coleta dados do formulário de cuidador</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... (specialty, experience, education, etc.) ...</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        dias <span class="op">=</span> request.form.getlist(<span class="st">&#39;dias[]&#39;</span>) <span class="co"># Pega múltiplos valores para checkboxes com mesmo nome</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        periodos <span class="op">=</span> request.form.getlist(<span class="st">&#39;periodos[]&#39;</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        inicio_imediato <span class="op">=</span> request.form.get(<span class="st">&#39;inicio_imediato&#39;</span>) <span class="op">==</span> <span class="st">&#39;sim&#39;</span> <span class="co"># Converte para booleano</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        pretensao_str <span class="op">=</span> request.form.get(<span class="st">&#39;pretensao&#39;</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        pretensao <span class="op">=</span> <span class="bu">float</span>(pretensao_str) <span class="cf">if</span> pretensao_str <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Concatena informações extras em &#39;skills&#39; - pode ser melhorado</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># armazenando &#39;dias&#39;, &#39;periodos&#39;, etc., em seus próprios campos ou em um JSON.</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># O modelo Caregiver já tem campos para dias_disponiveis, periodos_disponiveis.</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># A lógica de &#39;skills_full&#39; parece estar duplicando informação ou sendo uma forma</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># de contornar algo.</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        info_extra <span class="op">=</span> []</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dias: info_extra.append(<span class="ss">f&quot;Dias: </span><span class="sc">{</span><span class="st">&#39;, &#39;</span><span class="sc">.</span>join(dias)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> periodos: info_extra.append(<span class="ss">f&quot;Períodos: </span><span class="sc">{</span><span class="st">&#39;, &#39;</span><span class="sc">.</span>join(periodos)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        info_extra.append(<span class="ss">f&quot;Início imediato: </span><span class="sc">{</span><span class="st">&#39;Sim&#39;</span> <span class="cf">if</span> inicio_imediato <span class="cf">else</span> <span class="st">&#39;Não&#39;</span><span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pretensao <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: info_extra.append(<span class="ss">f&quot;Pretensão: R$ </span><span class="sc">{</span>pretensao<span class="sc">:.2f}</span><span class="ss">&quot;</span>)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>        skills_base <span class="op">=</span> request.form.get(<span class="st">&#39;skills&#39;</span>, <span class="st">&quot;&quot;</span>)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># A linha abaixo que junta skills com info_extra não parece estar no código fornecido,</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># mas o README indica que skills armazena &quot;Habilidades e competências&quot;.</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># No código fornecido, skills_full é construído e passado para o construtor.</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>        skills_full <span class="op">=</span> skills_base <span class="op">+</span> <span class="st">&quot; | &quot;</span> <span class="op">+</span> <span class="st">&quot; | &quot;</span>.join(info_extra) <span class="cf">if</span> info_extra <span class="cf">else</span> skills_base</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>        caregiver <span class="op">=</span> Caregiver(</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>            user<span class="op">=</span>user, <span class="co"># Passa o objeto User</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>            specialty<span class="op">=</span>request.form.get(<span class="st">&#39;specialty&#39;</span>),</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>            experience<span class="op">=</span><span class="bu">int</span>(request.form.get(<span class="st">&#39;experience&#39;</span>)), <span class="co"># Converter para int</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>            education<span class="op">=</span>request.form.get(<span class="st">&#39;education&#39;</span>),</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>            expertise_area<span class="op">=</span>request.form.get(<span class="st">&#39;expertise&#39;</span>), <span class="co"># &#39;expertise&#39; no form, &#39;expertise_area&#39; no modelo</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>            skills<span class="op">=</span>skills_full, <span class="co"># Usando a string combinada</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>            dias_disponiveis<span class="op">=</span><span class="st">&quot;, &quot;</span>.join(dias) <span class="cf">if</span> dias <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>            periodos_disponiveis<span class="op">=</span><span class="st">&quot;, &quot;</span>.join(periodos) <span class="cf">if</span> periodos <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>            inicio_imediato<span class="op">=</span>inicio_imediato,</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>            pretensao_salarial<span class="op">=</span>pretensao</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>        caregiver_service.save(caregiver)</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>        session[<span class="st">&#39;acting_profile&#39;</span>] <span class="op">=</span> <span class="st">&#39;caregiver&#39;</span> <span class="co"># Ativa o perfil recém-criado</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>        flash(<span class="st">&#39;Perfil de Cuidador cadastrado e ativado com sucesso!&#39;</span>, <span class="st">&#39;success&#39;</span>)</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;home.home&#39;</span>))</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;register/register_caregiver.html&quot;</span>) <span class="co"># 23</span></span></code></pre></div>
<p><strong>Rotas de registro de responsável e idoso:</strong></p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="at">@register_bp.route</span>(<span class="st">&#39;/responsible&#39;</span>, methods<span class="op">=</span>[<span class="st">&#39;GET&#39;</span>, <span class="st">&#39;POST&#39;</span>]) <span class="co"># 24</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> register_responsible(): <span class="co"># 25</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lógica similar ao register_caregiver</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">&quot;POST&quot;</span>:</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        user_id <span class="op">=</span> session.get(<span class="st">&#39;user_id&#39;</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> user_id: <span class="cf">return</span> redirect(url_for(<span class="st">&#39;login.login&#39;</span>))</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> user_service.get_by_id(user_id)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        responsible <span class="op">=</span> Responsible(</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>            user<span class="op">=</span>user,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>            relationship_with_elderly<span class="op">=</span>request.form.get(<span class="st">&#39;relationship_with_elderly&#39;</span>),</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>            primary_need_description<span class="op">=</span>request.form.get(<span class="st">&#39;primary_need_description&#39;</span>),</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>            preferred_contact_method<span class="op">=</span>request.form.get(<span class="st">&#39;preferred_contact_method&#39;</span>)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        responsible_service.save(responsible)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        session[<span class="st">&#39;acting_profile&#39;</span>] <span class="op">=</span> <span class="st">&#39;responsible&#39;</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>        flash(<span class="st">&#39;Perfil de Responsável cadastrado e ativado com sucesso!&#39;</span>, <span class="st">&#39;success&#39;</span>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;home.home&#39;</span>))</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;register/register_responsible.html&quot;</span>) <span class="co"># 26</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="at">@register_bp.route</span>(<span class="st">&#39;/elderly&#39;</span>, methods<span class="op">=</span>[<span class="st">&#39;GET&#39;</span>, <span class="st">&#39;POST&#39;</span>]) <span class="co"># 27</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> register_elderly(): <span class="co"># 28</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica se o usuário logado é um responsável</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&#39;user_id&#39;</span> <span class="kw">not</span> <span class="kw">in</span> session <span class="kw">or</span> session.get(<span class="st">&#39;acting_profile&#39;</span>) <span class="op">!=</span> <span class="st">&#39;responsible&#39;</span>:</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>        flash(<span class="st">&#39;Apenas responsáveis podem cadastrar idosos. Selecione o perfil de Responsável ou crie um.&#39;</span>, <span class="st">&#39;warning&#39;</span>)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Seria melhor redirecionar para login.select_acting_profile se já logado,</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ou para register.register_responsible se não tiver o perfil.</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;login.login&#39;</span>)) </span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">&quot;POST&quot;</span>:</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>        responsible_user_id <span class="op">=</span> session.get(<span class="st">&#39;user_id&#39;</span>) <span class="co"># O user_id da sessão é o ID do usuário</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Precisa pegar o objeto Responsible associado a este user_id</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>        responsible_profile <span class="op">=</span> responsible_service.get_responsible_by_user_id(responsible_user_id) <span class="co"># Correção aqui</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> responsible_profile:</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>            flash(<span class="st">&#39;Perfil de Responsável não encontrado. Não é possível cadastrar idoso.&#39;</span>, <span class="st">&#39;danger&#39;</span>)</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">&#39;home.home&#39;</span>)) <span class="co"># Ou para o dashboard do responsável</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Coleta dados do formulário do idoso</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> request.form.get(<span class="st">&#39;name&#39;</span>)</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... (coleta de todos os outros campos do idoso) ...</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>        birthdate_str <span class="op">=</span> request.form.get(<span class="st">&#39;birthdate&#39;</span>)</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>        birthdate_obj <span class="op">=</span> datetime.strptime(birthdate_str, <span class="st">&#39;%Y-%m-</span><span class="sc">%d</span><span class="st">&#39;</span>).date() <span class="cf">if</span> birthdate_str <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>        elderly <span class="op">=</span> Elderly(</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span>name,</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ... (todos os outros campos) ...</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>            birthdate<span class="op">=</span>birthdate_obj, <span class="co"># Passa o objeto date</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>            responsible<span class="op">=</span>responsible_profile <span class="co"># Associa o objeto Responsible</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>        elderly_service.save(elderly)</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>        flash(<span class="st">&#39;Idoso cadastrado com sucesso!&#39;</span>, <span class="st">&#39;success&#39;</span>)</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Redirecionar para o dashboard do responsável ou lista de idosos</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;responsible_dashboard.my_elderly&#39;</span>)) <span class="co"># Sugestão de redirect</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;register/register_elderly.html&quot;</span>) <span class="co"># 29</span></span></code></pre></div>
<p><strong>Explicação do app/routes/register.py</strong>:</p>
<ol type="1">
<li><p><strong>Importações</strong>:</p>
<ul>
<li>Inclui os modelos e serviços relevantes.</li>
<li><code>from app.models.user import User, etc.</code>: Importa as
classes dos modelos para criar novas instâncias.</li>
<li><code>from app.services import ...</code>: Importa os serviços para
salvar os novos objetos no banco.</li>
<li><code>from datetime import datetime</code>: Usado para converter
strings de data do formulário em objetos date.</li>
</ul></li>
<li><p><code>register_bp = Blueprint("register", __name__, url_prefix="/register")</code>:
Cria o blueprint “register”.</p></li>
<li><p><code>@register_bp.route("/", methods=["GET", "POST"])</code>:
Rota principal para registro de usuário (/register/).</p></li>
<li><p><code>def register()</code>: Função para registrar um novo
User.</p>
<ul>
<li><strong>Processamento POST</strong>:
<ul>
<li>Coleta dados do formulário
(<code>request.form.get(...)</code>).</li>
<li><strong>Ponto de Atenção</strong>: A data de nascimento (birthdate)
vem como string e precisa ser convertida para um objeto date do Python
antes de ser salva no modelo User. O código atual passa a string
diretamente para o construtor User. O construtor do User também recebe
birthdate diretamente. O modelo User espera db.Date. SQLAlchemy pode
lidar com strings no formato ISO (YYYY-MM-DD) para campos Date, mas é
mais seguro e explícito converter antes. A sugestão de conversão
(<code>datetime.strptime(birthdate_str, '%Y-%m-%d').date()</code>) foi
adicionada nos comentários do código acima.</li>
<li><code>existing_user = user_service.get_by_email_or_phone_or_cpf(...)</code>:
Verifica se já existe um usuário com o mesmo email, telefone ou CPF. Boa
prática para evitar duplicidade.</li>
<li><code>user_service.save(user)</code>: Salva o novo usuário no
banco.</li>
<li><code>session['user_id'] = user.id</code>: Loga o usuário
recém-registrado.</li>
<li><code>return redirect(url_for('register.select_profile'))</code>:
Redireciona para a seleção de perfil (Cuidador ou Responsável).</li>
</ul></li>
<li><code>except ValueError as e</code>: Pode capturar erros de
conversão, como de uma string de data mal formatada.</li>
<li><code>except Exception as e</code>: Captura genérica para outros
erros. É bom logar e para depuração.</li>
<li><code>return render_template("register/register.html")</code>: Exibe
o formulário de registro do usuário.</li>
</ul></li>
<li><p><code>@register_bp.route("/select-profile", methods=["GET"])</code>:
Rota /register/select-profile.</p>
<ul>
<li><code>def select_profile()</code>: Permite ao usuário
recém-registrado (ou logado sem perfil) escolher qual perfil criar.</li>
<li><code>return render_template("register/select.html", user=user)</code>:
Exibe a página de seleção de perfil.</li>
</ul></li>
<li><p><code>@register_bp.route("/add-profile", methods=["GET", "POST"])</code>:
Rota /register/add-profile.</p>
<ul>
<li><code>def add_profile()</code>: Permite a um usuário existente
adicionar um segundo perfil (se ele só tiver um). A lógica é similar à
de login.select_acting_profile para verificar perfis existentes e
determinar qual pode ser adicionado. O template profile/select.html (não
fornecido, mas mencionado no README) deve lidar com essa interface.</li>
</ul></li>
<li><p><code>@register_bp.route('/caregiver', methods=['GET', 'POST'])</code>:
Rota /register/caregiver.</p>
<ul>
<li><code>def register_caregiver()</code>: Processa o formulário de
registro do perfil de Cuidador.
<ul>
<li>Coleta dados específicos do cuidador.</li>
<li><code>request.form.getlist('dias[]')</code>: Obtém uma lista de
valores de checkboxes com o mesmo nome (ex: dias[]).</li>
<li>A forma como skills_full é montada, concatenando skills com
info_extra (dias, periodos, etc.) pode não ser ideal. O modelo Caregiver
já possui campos como dias_disponiveis, periodos_disponiveis. Parece que
a informação está sendo duplicada ou armazenada de forma menos
estruturada no campo skills. O código que está nos arquivos não
concatena skills com info_extra da forma que imaginei, mas sim atribui a
skills_full o valor de skills do formulário e depois uma string com
info_extra. O CaregiverService salva o objeto Caregiver com estes campos
separados.</li>
<li>Cria e salva o objeto Caregiver, associando-o ao User logado.</li>
<li>Define <code>session['acting_profile'] = 'caregiver'</code>.</li>
</ul></li>
<li><code>return render_template("register/register_caregiver.html")</code>:
Exibe o formulário de registro de cuidador.</li>
</ul></li>
<li><p><code>@register_bp.route('/responsible', methods=['GET', 'POST'])</code>:
Rota /register/responsible.</p>
<ul>
<li><code>def register_responsible()</code>: Processa o formulário de
registro do perfil de Responsável, similar ao de Cuidador.</li>
<li><code>return render_template("register/register_responsible.html")</code>:
Exibe o formulário de registro de responsável.</li>
</ul></li>
<li><p><code>@register_bp.route('/elderly', methods=['GET', 'POST'])</code>:
Rota /register/elderly.</p>
<ul>
<li><code>def register_elderly()</code>: Processa o formulário de
cadastro de um Idoso.
<ul>
<li>Verifica se o usuário logado está atuando como ‘responsible’.</li>
<li>Obtém o perfil Responsible do usuário logado usando
<code>responsible_service.get_responsible_by_user_id(responsible_user_id)</code>.
(No código fornecido, ele usa
<code>responsible_service.get_responsible_by_id(responsible_id)</code>
onde responsible_id é <code>session.get('user_id')</code>. Isso pode
estar incorreto se o ID do perfil Responsible não for o mesmo que o
user_id. O método get_responsible_by_user_id é mais apropriado
aqui).</li>
<li>Coleta os dados do idoso.</li>
<li>Converte birthdate para objeto date.</li>
<li>Cria e salva o objeto Elderly, associando-o ao Responsible.</li>
<li>Redireciona (sugestão: para a lista de idosos do responsável).<br />
</li>
</ul></li>
<li><code>return render_template("register/register_elderly.html")</code>:
Exibe o formulário de cadastro de idoso.</li>
</ul></li>
</ol>
<h4
id="approutescaregivers.py"><strong>app/routes/caregivers.py</strong></h4>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Blueprint, render_template  <span class="co"># 1</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.services <span class="im">import</span> caregiver_service, elderly_service  <span class="co"># 2</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>caregivers_bp <span class="op">=</span> Blueprint(<span class="st">&quot;caregivers&quot;</span>, <span class="va">__name__</span>, url_prefix<span class="op">=</span><span class="st">&quot;/caregivers&quot;</span>) <span class="co"># 3</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="at">@caregivers_bp.route</span>(<span class="st">&quot;/&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>]) <span class="co"># 4</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> list_caregivers(): <span class="co"># 5</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">    List all caregivers.</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    caregivers <span class="op">=</span> caregiver_service.get_all_caregivers() <span class="co"># 6</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;list/caregiver_list.html&quot;</span>, caregivers<span class="op">=</span>caregivers) <span class="co"># 7</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="at">@caregivers_bp.route</span>(<span class="st">&quot;/elderly&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>]) <span class="co"># 8</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> list_elderly(): <span class="co"># 9</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Lista todos os idosos disponíveis para cuidadores.</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    elderly_list <span class="op">=</span> elderly_service.get_all() <span class="co"># 10</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;list/elderly_list.html&quot;</span>, elderly_list<span class="op">=</span>elderly_list) <span class="co"># 11</span></span></code></pre></div>
<p><strong>Explicação do app/routes/caregivers.py</strong>:</p>
<ol type="1">
<li><p><strong>Importações</strong>:</p>
<ul>
<li><code>Blueprint, render_template</code>: Componentes básicos do
Flask para criar rotas e renderizar templates.</li>
</ul></li>
<li><p><strong>Importação de Serviços</strong>:</p>
<ul>
<li><code>caregiver_service</code>: Para buscar cuidadores do banco de
dados.</li>
<li><code>elderly_service</code>: Para buscar idosos do banco de
dados.</li>
</ul></li>
<li><p><code>caregivers_bp = Blueprint("caregivers", __name__, url_prefix="/caregivers")</code>:
Cria o blueprint “caregivers” com prefixo /caregivers.</p></li>
<li><p><code>@caregivers_bp.route("/", methods=["GET"])</code>: Rota
/caregivers/ para listar cuidadores.</p>
<ul>
<li><code>def list_caregivers()</code>: Função controladora.</li>
<li><code>caregivers = caregiver_service.get_all_caregivers()</code>:
Busca todos os cuidadores através do serviço.</li>
<li><code>return render_template("list/caregiver_list.html", caregivers=caregivers)</code>:
Renderiza o template list/caregiver_list.html, passando a lista de
cuidadores.</li>
</ul></li>
<li><p><code>@caregivers_bp.route("/elderly", methods=["GET"])</code>:
Rota /caregivers/elderly para listar idosos (presumivelmente, para que
cuidadores vejam “oportunidades”).</p>
<ul>
<li><code>def list_elderly()</code>: Função controladora.</li>
<li><code>elderly_list = elderly_service.get_all()</code>: Busca todos
os idosos.</li>
<li><code>return render_template("list/elderly_list.html", elderly_list=elderly_list)</code>:
Renderiza o template list/elderly_list.html, passando a lista de idosos.
#### app/routes/responsible_dashboard.py</li>
</ul></li>
</ol>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># app/routes/responsible_dashboard.py</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Blueprint, render_template, session, redirect, url_for, flash <span class="co"># 1</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.services <span class="im">import</span> elderly_service, responsible_service <span class="co"># 2</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>responsible_dashboard_bp <span class="op">=</span> Blueprint(<span class="st">&quot;responsible_dashboard&quot;</span>, <span class="va">__name__</span>, url_prefix<span class="op">=</span><span class="st">&quot;/responsible&quot;</span>) <span class="co"># 3</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="at">@responsible_dashboard_bp.route</span>(<span class="st">&quot;/my-elderly&quot;</span>) <span class="co"># 4</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_elderly(): <span class="co"># 5</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&#39;user_id&#39;</span> <span class="kw">not</span> <span class="kw">in</span> session <span class="kw">or</span> session.get(<span class="st">&#39;acting_profile&#39;</span>) <span class="op">!=</span> <span class="st">&#39;responsible&#39;</span>: <span class="co"># 6</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        flash(<span class="st">&#39;Acesso não autorizado. Por favor, faça login como Responsável.&#39;</span>, <span class="st">&#39;danger&#39;</span>) <span class="co"># Mensagem melhorada</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;login.login&#39;</span>))</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    user_id <span class="op">=</span> session[<span class="st">&#39;user_id&#39;</span>]</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    responsible <span class="op">=</span> responsible_service.get_responsible_by_user_id(user_id) <span class="co"># 7</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> responsible:</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        flash(<span class="st">&#39;Perfil de Responsável não encontrado.&#39;</span>, <span class="st">&#39;danger&#39;</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;home.home&#39;</span>)) <span class="co"># Ou talvez para &#39;register.register_responsible&#39;</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    elderly_list <span class="op">=</span> elderly_service.get_by_responsible_id(responsible.<span class="bu">id</span>) <span class="co"># 8</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;list/my_elderly_list.html&quot;</span>, elderly_list<span class="op">=</span>elderly_list) <span class="co"># 9</span></span></code></pre></div>
<p><strong>Explicação do
app/routes/responsible_dashboard.py</strong>:</p>
<ol type="1">
<li><p><strong>Importações</strong>:</p>
<ul>
<li>Padrão para rotas:
<code>Blueprint, render_template, session, redirect, url_for, flash</code>.</li>
</ul></li>
<li><p><strong>Importação de Serviços</strong>:</p>
<ul>
<li><code>elderly_service</code>: Para buscar idosos do banco de
dados.</li>
<li><code>responsible_service</code>: Para buscar perfis de
responsáveis.</li>
</ul></li>
<li><p><code>responsible_dashboard_bp = Blueprint("responsible_dashboard", __name__, url_prefix="/responsible")</code>:
Cria o blueprint para o dashboard do responsável com prefixo
/responsible.</p></li>
<li><p><code>@responsible_dashboard_bp.route("/my-elderly")</code>: Rota
/responsible/my-elderly para listar os idosos de um responsável.</p>
<ul>
<li>O README também menciona /responsible/dashboard e
/responsible/elderly/<int:elderly_id> que não estão implementados neste
arquivo.</li>
</ul></li>
<li><p><code>def my_elderly()</code>: Função controladora.</p>
<ul>
<li><strong>Verificação de Autorização</strong>: Garante que o usuário
esteja logado e atuando como ‘responsible’.</li>
<li><code>responsible = responsible_service.get_responsible_by_user_id(user_id)</code>:
Busca o perfil Responsible associado ao user_id da sessão.</li>
<li><code>elderly_list = elderly_service.get_by_responsible_id(responsible.id)</code>:
Busca todos os idosos associados a este responsável.</li>
<li><code>return render_template("list/my_elderly_list.html", elderly_list=elderly_list)</code>:
Renderiza o template list/my_elderly_list.html com a lista de idosos.
#### app/routes/contact.py</li>
</ul></li>
</ol>
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Blueprint, render_template <span class="co"># 1</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>contact_bp <span class="op">=</span> Blueprint(<span class="st">&quot;contact&quot;</span>, <span class="va">__name__</span>, url_prefix<span class="op">=</span><span class="st">&quot;/contact&quot;</span>) <span class="co"># 2</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="at">@contact_bp.route</span>(<span class="st">&quot;/&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>]) <span class="co"># 3</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># O README menciona (GET, POST) e processamento de formulário, mas aqui é só GET</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> contact(): <span class="co"># 4</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Contact page.</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;contact/contact.html&quot;</span>) <span class="co"># 5</span></span></code></pre></div>
<p><strong>Explicação do app/routes/contact.py</strong>:</p>
<ol type="1">
<li><p><strong>Importações</strong>:</p>
<ul>
<li><code>Blueprint, render_template</code>: Componentes básicos do
Flask para criar rotas e renderizar templates.</li>
</ul></li>
<li><p><code>contact_bp = Blueprint("contact", __name__, url_prefix="/contact")</code>:
Cria o blueprint “contact” com prefixo /contact.</p></li>
<li><p><code>@contact_bp.route("/", methods=["GET"])</code>: Rota
/contact/ para a página de contato.</p>
<ul>
<li><strong>Ponto de Atenção</strong>: O README.md especifica que esta
rota aceita GET e POST e processa um formulário de contato. A
implementação atual no contact.py apenas lida com GET e exibe a página.
A lógica de processamento do formulário (se existir) não está aqui. O
template contact/contact.html possui um formulário, mas ele não tem um
action ou method que o submeta para este endpoint para processamento
POST.</li>
</ul></li>
<li><p><code>def contact()</code>: Função controladora.</p>
<ul>
<li><code>return render_template("contact/contact.html")</code>:
Renderiza a página de contato. #### app/routes/user.py</li>
</ul></li>
</ol>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Blueprint, render_template, request, redirect, url_for, session, flash <span class="co"># 1</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.services <span class="im">import</span> caregiver_service, responsible_service, user_service <span class="co"># 2</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>user_bp <span class="op">=</span> Blueprint(<span class="st">&quot;user&quot;</span>, <span class="va">__name__</span>, url_prefix<span class="op">=</span><span class="st">&quot;/user&quot;</span>) <span class="co"># 3</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="at">@user_bp.route</span>(<span class="st">&quot;/profiles&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>, <span class="st">&quot;POST&quot;</span>]) <span class="co"># 4</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> manage_profiles(): <span class="co"># 5</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    user_id <span class="op">=</span> session.get(<span class="st">&#39;user_id&#39;</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> user_id: <span class="co"># 6</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&#39;login.login&#39;</span>))</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    user <span class="op">=</span> user_service.get_by_id(user_id)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mesma observação sobre buscar caregiver/responsible via user.caregiver/user.responsible</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    caregiver <span class="op">=</span> caregiver_service.get_caregiver_by_id(user_id) <span class="cf">if</span> user <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> caregiver <span class="kw">and</span> user: caregiver <span class="op">=</span> caregiver_service.get_caregiver_by_email(user.email) <span class="co"># Fallback</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    responsible <span class="op">=</span> responsible_service.get_responsible_by_id(user_id) <span class="cf">if</span> user <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> responsible <span class="kw">and</span> user: responsible <span class="op">=</span> responsible_service.get_responsible_by_email(user.email) <span class="co"># Fallback</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    has_caregiver <span class="op">=</span> <span class="bu">bool</span>(caregiver)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    has_responsible <span class="op">=</span> <span class="bu">bool</span>(responsible)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    acting_profile <span class="op">=</span> session.get(<span class="st">&#39;acting_profile&#39;</span>)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">&quot;POST&quot;</span>: <span class="co"># 7</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        selected_profile <span class="op">=</span> request.form.get(<span class="st">&#39;selected_profile&#39;</span>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> selected_profile <span class="kw">in</span> [<span class="st">&#39;caregiver&#39;</span>, <span class="st">&#39;responsible&#39;</span>]:</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verifica se o usuário realmente tem o perfil que está tentando selecionar</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (selected_profile <span class="op">==</span> <span class="st">&#39;caregiver&#39;</span> <span class="kw">and</span> has_caregiver) <span class="kw">or</span> <span class="op">\</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>               (selected_profile <span class="op">==</span> <span class="st">&#39;responsible&#39;</span> <span class="kw">and</span> has_responsible):</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>                session[<span class="st">&#39;acting_profile&#39;</span>] <span class="op">=</span> selected_profile</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>                flash(<span class="ss">f&#39;Agora você está atuando como </span><span class="sc">{</span><span class="st">&quot;Cuidador&quot;</span> <span class="cf">if</span> selected_profile<span class="op">==</span><span class="st">&quot;caregiver&quot;</span> <span class="cf">else</span> <span class="st">&quot;Responsável&quot;</span><span class="sc">}</span><span class="ss">.&#39;</span>, <span class="st">&#39;success&#39;</span>)</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> redirect(url_for(<span class="st">&#39;home.home&#39;</span>))</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>                flash(<span class="st">&#39;Perfil selecionado não disponível para sua conta. Crie o perfil primeiro.&#39;</span>, <span class="st">&#39;danger&#39;</span>)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Poderia redirecionar para &#39;register.add_profile&#39; ou &#39;register.select_profile&#39;</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>            flash(<span class="st">&#39;Selecione um perfil válido.&#39;</span>, <span class="st">&#39;warning&#39;</span>)</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># O template &quot;user/manage_profiles.html&quot; não foi fornecido.</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ele deve permitir ao usuário ver seus perfis e trocar o &#39;acting_profile&#39;.</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template( <span class="co"># 8</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;user/manage_profiles.html&quot;</span>, <span class="co"># Este template não foi fornecido</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        has_caregiver<span class="op">=</span>has_caregiver,</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>        has_responsible<span class="op">=</span>has_responsible,</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>        acting_profile<span class="op">=</span>acting_profile</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<p><strong>Explicação do app/routes/user.py</strong>:</p>
<ol type="1">
<li><strong>Importações</strong>:
<ul>
<li>Padrão para rotas:
<code>Blueprint, render_template, request, redirect, url_for, session, flash</code>.</li>
</ul></li>
<li><strong>Importação de Serviços</strong>:
<ul>
<li>Todos os três serviços principais:
<code>caregiver_service, responsible_service, user_service</code>.</li>
</ul></li>
<li><code>user_bp = Blueprint("user", __name__, url_prefix="/user")</code>:
Cria o blueprint “user” com prefixo /user.
<ul>
<li><strong>Ponto de Atenção</strong>: Como mencionado anteriormente,
este user_bp não está registrado em app/<strong>init</strong>.py, então
suas rotas (como /user/profiles) não estarão acessíveis. Isso precisa
ser corrigido adicionando
<code>from app.routes.user import user_bp</code> e
<code>app.register_blueprint(user_bp)</code> em
app/<strong>init</strong>.py.</li>
</ul></li>
<li><code>@user_bp.route("/profiles", methods=["GET", "POST"])</code>:
Rota /user/profiles para gerenciar os perfis do usuário (trocar entre
Cuidador/Responsável se tiver ambos).
<ul>
<li><code>def manage_profiles()</code>: Função controladora.</li>
<li><strong>Verificação de Sessão</strong>: Garante que o usuário esteja
logado.</li>
<li><strong>Processamento POST</strong>: Se o usuário submeter um
formulário para trocar o perfil ativo (acting_profile), esta lógica
atualiza a sessão.</li>
<li><code>return render_template("user/manage_profiles.html", ...)</code>:
Renderiza um template (não fornecido) para o gerenciamento de perfis,
passando informações sobre os perfis existentes e o perfil ativo. O
navbar_login.html tem um link para login.select_acting_profile, que tem
uma funcionalidade similar. Pode haver uma sobreposição ou
manage_profiles é uma versão mais completa.</li>
</ul></li>
</ol>
<h3 id="camada-de-serviço-appservices"><strong>5.4. Camada de Serviço
(app/services/)</strong></h3>
<p>A camada de serviço encapsula a lógica de negócios da aplicação,
separando-a dos controladores (rotas). Isso torna o código mais
organizado, testável e reutilizável.</p>
<h4
id="appservicesinit.py"><strong>app/services/<strong>init</strong>.py</strong></h4>
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This file makes the services directory a Python package</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.services.caregiver_service <span class="im">import</span> CaregiverService <span class="co"># 1</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.services.elderly_service <span class="im">import</span> ElderlyService</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.services.responsible_service <span class="im">import</span> ResponsibleService</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># O user_service.py contém funções, não uma classe, então não é instanciado aqui.</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create service instances # 2</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>caregiver_service <span class="op">=</span> CaregiverService()</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>responsible_service <span class="op">=</span> ResponsibleService()</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>elderly_service <span class="op">=</span> ElderlyService()</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co"># user_service é importado como um módulo de funções, ex: from app.services import user_service</span></span></code></pre></div>
<p><strong>Explicação do
app/services/<strong>init</strong>.py</strong>:</p>
<ol type="1">
<li><strong>Importações</strong>:
<ul>
<li>Importa as classes de serviço dos respectivos módulos.</li>
</ul></li>
<li><strong>Instanciação de Serviços</strong>:
<ul>
<li>Cria instâncias únicas (singletons, efetivamente) das classes de
serviço.</li>
<li>Essas instâncias são então importadas e usadas pelos controladores
(rotas).</li>
<li>Por exemplo, em app/routes/login.py, você tem
<code>from app.services import caregiver_service</code>.</li>
</ul></li>
<li><strong>Ponto de Atenção (Consistência)</strong>:
<ul>
<li>O README.md menciona “Refatoração de Serviços: Padronizar a
abordagem (funcional vs. classe) nos serviços”.</li>
<li>Isso é visível aqui: <code>CaregiverService</code>,
<code>ElderlyService</code>, e <code>ResponsibleService</code> são
classes, enquanto <code>user_service.py</code> exporta um conjunto de
funções.</li>
<li>Para consistência, <code>user_service.py</code> poderia também ser
refatorado para uma classe <code>UserService</code>.</li>
<li>No entanto, a abordagem funcional para user_service não é
inerentemente errada, apenas diferente das outras. ####
<strong>app/services/user_service.py</strong></li>
</ul></li>
</ol>
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># app/services/user_service.py</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app <span class="im">import</span> db <span class="co"># 1</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.user <span class="im">import</span> User <span class="co"># 2</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save(user: User): <span class="co"># 3 - Tipagem (User) é boa prática</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica se o email já existe antes de tentar salvar.</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Esta verificação já é feita na rota de registro, mas tê-la aqui</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># no serviço garante a regra de negócio independentemente de quem chama.</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    existing_user_by_email <span class="op">=</span> get_by_email(user.email)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> existing_user_by_email <span class="kw">and</span> (<span class="kw">not</span> <span class="bu">hasattr</span>(user, <span class="st">&#39;id&#39;</span>) <span class="kw">or</span> existing_user_by_email.<span class="bu">id</span> <span class="op">!=</span> user.<span class="bu">id</span>): <span class="co"># Adicionado para permitir atualização</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;Email já existe em nosso sistema.&quot;</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Seria bom adicionar verificação de CPF e telefone únicos aqui também, se for uma regra estrita.</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># A checagem na rota /register usa get_by_email_or_phone_or_cpf.</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Se &#39;save&#39; é usado tanto para criar quanto para atualizar, a lógica de unicidade precisa</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># considerar o ID do usuário sendo atualizado.</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># O modelo User já tem &#39;unique=True&#39; para email, cpf, phone.</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># O banco de dados vai impor isso, mas tratar o erro de forma amigável na aplicação é melhor.</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    db.session.add(user) <span class="co"># 4</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>        db.session.commit() <span class="co"># 5</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e: <span class="co"># Ex: IntegrityError do SQLAlchemy se unique constraint falhar</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>        db.session.rollback() <span class="co"># 6</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Logar o erro &#39;e&#39;</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Re-levantar uma exceção mais específica ou retornar um indicador de falha</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># A exceção ValueError já é levantada acima para email duplicado.</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Se for uma constraint unique do BD, poderia ser algo como:</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># from sqlalchemy.exc import IntegrityError</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># except IntegrityError:</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     db.session.rollback()</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     raise ValueError(&quot;Erro de integridade: CPF ou Telefone já cadastrado.&quot;)</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> e <span class="co"># Re-levanta a exceção original se não for tratada especificamente</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> user</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_by_id(user_id: <span class="bu">int</span>) <span class="op">-&gt;</span> User <span class="op">|</span> <span class="va">None</span>: <span class="co"># 7 - Tipagem de retorno</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a><span class="co">    Get a user by ID.</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> User.query.get(user_id) <span class="co"># 8</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_by_email(email: <span class="bu">str</span>) <span class="op">-&gt;</span> User <span class="op">|</span> <span class="va">None</span>: <span class="co"># 9</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a><span class="co">    Get a user by email.</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> User.query.filter_by(email<span class="op">=</span>email).first() <span class="co"># 10</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_by_email_or_phone_or_cpf(email: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>, phone: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>, cpf: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> User <span class="op">|</span> <span class="va">None</span>: <span class="co"># 11</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a><span class="co">    Get a user by email, phone, or CPF.</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> User.query <span class="co"># 12</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Constrói a query dinamicamente</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Nota: Se múltiplos campos forem fornecidos, a query buscará por um usuário que corresponda a TODOS eles.</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Se a intenção é OR (email OU phone OU cpf), a lógica precisa de or_() do SQLAlchemy.</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ex: from sqlalchemy import or_</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># filters = []</span></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if email: filters.append(User.email == email)</span></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if filters: query = query.filter(or_(*filters)) else: return None (ou query.all() se fizer sentido)</span></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># A rota de registro usa isso para verificar se *qualquer um* dos campos já existe.</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Se essa é a intenção, a query atual (com múltiplos filter_by encadeados) resultaria em AND.</span></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Para OR, seria:</span></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># from sqlalchemy import or_</span></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return User.query.filter(or_(User.email == email, User.phone == phone, User.cpf == cpf)).first()</span></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (considerando que apenas um deles pode ser fornecido, ou que eles não podem ser nulos na chamada)</span></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># A implementação atual:</span></span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> email:</span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>        query <span class="op">=</span> query.filter_by(email<span class="op">=</span>email)</span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> phone: <span class="co"># Se email e phone forem passados, buscará User com ESSE email E ESSE phone.</span></span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>        query <span class="op">=</span> query.filter_by(phone<span class="op">=</span>phone)</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cpf:</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>        query <span class="op">=</span> query.filter_by(cpf<span class="op">=</span>cpf)</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> query.first() <span class="co"># 13</span></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_all() <span class="op">-&gt;</span> <span class="bu">list</span>[User]: <span class="co"># 14</span></span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a><span class="co">    Get all users.</span></span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> User.query.<span class="bu">all</span>() <span class="co"># 15</span></span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delete(user: User) <span class="op">-&gt;</span> <span class="va">None</span>: <span class="co"># 16</span></span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a><span class="co">    Delete a user.</span></span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>    db.session.delete(user) <span class="co"># 17</span></span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>    db.session.commit() <span class="co"># 18</span></span></code></pre></div>
<p><strong>Explicação do app/services/user_service.py</strong>:</p>
<p>Este módulo usa uma abordagem funcional (conjunto de funções) em vez
de uma classe de serviço.</p>
<ol type="1">
<li><strong>Importações</strong>:
<ul>
<li><code>from app import db</code>: Importa a instância db.</li>
<li><code>from app.models.user import User</code>: Importa o modelo
User.</li>
</ul></li>
<li><code>def save(user: User)</code>: Salva um objeto User no banco.
<ul>
<li>Inclui uma verificação para email duplicado. Seria bom expandir para
CPF e telefone se a intenção é que save seja o único ponto de entrada
para persistência que valide isso.</li>
<li><strong>Ponto de Atenção para Atualização</strong>: Se esta função
save for usada também para atualizar um usuário existente, a verificação
de unicidade do email
(<code>if existing_user_by_email and existing_user_by_email.id != user.id:</code>)
deve garantir que não está comparando o usuário consigo mesmo. A
implementação atual não lida bem com atualizações se o email não for
alterado. A lógica de <code>existing_user_by_email.id != user.id</code>
tenta contornar isso, mas <code>user.id</code> pode não existir se for
um novo usuário. Uma abordagem comum é ter métodos
<code>create_user</code> e <code>update_user</code> separados.</li>
<li><code>db.session.add(user)</code>: Adiciona o objeto user à sessão
do SQLAlchemy. As alterações ainda não foram enviadas ao banco. -
<code>db.session.commit()</code>: Persiste todas as alterações na sessão
atual (incluindo o novo usuário) no banco de dados.</li>
<li><code>db.session.rollback()</code>: Em caso de erro durante o commit
(ex: violação de constraint unique no banco), desfaz as alterações na
sessão atual.</li>
</ul></li>
<li><code>def get_by_id(user_id: int) -&gt; User | None</code>: Busca um
usuário pelo seu ID. <code>-&gt; User | None</code> é uma anotação de
tipo de retorno (type hint) indicando que a função retorna um objeto
User ou None.
<ul>
<li><code>User.query.get(user_id)</code>: Método conveniente do
SQLAlchemy para buscar um objeto pela sua chave primária.</li>
</ul></li>
<li><code>def get_by_email(email: str) -&gt; User | None</code>: Busca
um usuário pelo email.
<ul>
<li><code>User.query.filter_by(email=email).first()</code>: Realiza uma
consulta filtrando pelo campo email e retorna o primeiro resultado
encontrado (ou None).</li>
</ul></li>
<li><code>def get_by_email_or_phone_or_cpf(...)</code>: Tenta buscar um
usuário por email, telefone ou CPF.
<ul>
<li><strong>Ponto de Atenção na Lógica de Filtro</strong>: A forma como
os filtros são aplicados (<code>query = query.filter_by(...)</code>
encadeados) resulta em uma condição AND. Se você passar email e
telefone, ele buscará um usuário que tenha ambos. Se a intenção na rota
de registro é verificar se qualquer um desses campos já existe em
qualquer usuário, a query deveria usar OR. A rota de registro chama esta
função com os três campos. Para a validação de “já existe”, a query
deveria ser algo como:
<code>User.query.filter(or_(User.email == email, User.phone == phone, User.cpf == cpf)).first()</code>.
A implementação atual só retornaria um usuário se ele correspondesse a
todos os critérios não nulos fornecidos.</li>
<li><code>query = User.query</code>: Inicia a construção de uma query
SQLAlchemy.</li>
<li><code>return query.first()</code>: Executa a query e retorna o
primeiro resultado.</li>
</ul></li>
<li><code>def get_all() -&gt; list[User]</code>: Retorna uma lista de
todos os usuários.
<ul>
<li><code>return User.query.all()</code>: Executa uma query para buscar
todos os registros da tabela User.</li>
</ul></li>
<li><code>def delete(user: User) -&gt; None</code>: Remove um usuário do
banco.
<ul>
<li><code>db.session.delete(user)</code>: Marca o objeto user para
exclusão na sessão.</li>
<li><code>db.session.commit()</code>: Efetiva a exclusão no banco.</li>
</ul></li>
</ol>
<h4
id="appservicescaregiver_service.py"><strong>app/services/caregiver_service.py</strong></h4>
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app <span class="im">import</span> db <span class="co"># 1</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.caregiver <span class="im">import</span> Caregiver <span class="co"># 2</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># from app.models.user import User # Importação movida para dentro do método que a usa</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CaregiverService: <span class="co"># 3</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save(<span class="va">self</span>, caregiver: Caregiver) <span class="op">-&gt;</span> <span class="va">None</span>: <span class="co"># 4</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Save a new caregiver to the database.</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        db.session.add(caregiver)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        db.session.commit() <span class="co"># Adicionar tratamento de exceção (try/except/rollback) aqui seria bom</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_all_caregivers(<span class="va">self</span>): <span class="co"># 5</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieve all caregivers from the database.</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Caregiver.query.<span class="bu">all</span>()</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_caregiver_by_id(<span class="va">self</span>, caregiver_id: <span class="bu">int</span>): <span class="co"># 6</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieve a caregiver by their ID. (ID do Caregiver, não do User)</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Caregiver.query.get(caregiver_id)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_caregiver_by_email(<span class="va">self</span>, email: <span class="bu">str</span>): <span class="co"># 7</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Recupera um cuidador pelo email do usuário associado.</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> app.models.user <span class="im">import</span> User <span class="co"># 8 - Importação local</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> User.query.filter_by(email<span class="op">=</span>email).first()</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> user: <span class="co"># Se o usuário com este email existir</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Busca o Caregiver associado a este user.id</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># O modelo Caregiver tem user_id como FK para users.id</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># E tem um relacionamento &#39;user&#39;.</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Poderia ser: return user.caregiver se o relacionamento estiver configurado para carregar.</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>            <span class="co"># A query atual é explícita:</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Caregiver.query.filter_by(user_id<span class="op">=</span>user.<span class="bu">id</span>).first()</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code></pre></div>
<p><strong>Explicação do app/services/caregiver_service.py</strong>:</p>
<ol type="1">
<li><p><strong>Importações</strong>:</p>
<ul>
<li><code>from app import db</code>: Importa db.</li>
<li><code>from app.models.caregiver import Caregiver</code>: Importa o
modelo Caregiver.</li>
</ul></li>
<li><p><code>class CaregiverService</code>: Define a classe de serviço
para lógica relacionada a cuidadores.</p></li>
<li><p><code>def save(self, caregiver: Caregiver) -&gt; None</code>:
Salva um objeto Caregiver.</p>
<ul>
<li><strong>Ponto de Atenção</strong>: Assim como no user_service, falta
tratamento de exceções (try/except db.session.rollback()) no
commit.</li>
</ul></li>
<li><p><code>def get_all_caregivers(self)</code>: Retorna todos os
cuidadores.</p></li>
<li><p><code>def get_caregiver_by_id(self, caregiver_id: int)</code>:
Busca um cuidador pelo seu ID (Caregiver.id, não User.id).</p></li>
<li><p><code>def get_caregiver_by_email(self, email: str)</code>: Busca
um perfil de cuidador associado a um usuário com o email fornecido.</p>
<ul>
<li><code>from app.models.user import User</code>: Importação local para
evitar dependência circular no nível do módulo, se User também
importasse algo de caregiver_service (o que não é o caso aqui, mas é uma
prática defensiva).</li>
<li>Primeiro, busca o User pelo email.</li>
<li>Se o User for encontrado, busca o Caregiver que tem user_id igual ao
id desse User.</li>
</ul></li>
</ol>
<h4
id="appservicesresponsible_service.py"><strong>app/services/responsible_service.py</strong></h4>
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app <span class="im">import</span> db <span class="co"># 1</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.responsible <span class="im">import</span> Responsible <span class="co"># 2</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># from app.models.user import User # Importação movida</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResponsibleService: <span class="co"># 3</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save(<span class="va">self</span>, responsible: Responsible): <span class="co"># 4</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Save a new responsible to the database.</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>            db.session.add(responsible)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>            db.session.commit()</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> responsible <span class="co"># Retorna o objeto salvo, pode ser útil</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>            db.session.rollback()</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;Erro ao salvar no banco de dados: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>) <span class="co"># Bom para log, mas não ideal para produção</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="co"># Re-levanta a exceção para ser tratada na camada superior (rota)</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_all_responsibles(<span class="va">self</span>): <span class="co"># 5</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieve all responsibles from the database.</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Responsible.query.<span class="bu">all</span>()</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_responsible_by_id(<span class="va">self</span>, responsible_id: <span class="bu">int</span>): <span class="co"># 6</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieve a responsible by their ID. (Responsible.id)</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Responsible.query.get(responsible_id)</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_responsible_by_email(<span class="va">self</span>, email: <span class="bu">str</span>): <span class="co"># 7</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieve a responsible by their email (busca pelo user.email).</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> app.models.user <span class="im">import</span> User <span class="co"># Importação local</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> User.query.filter_by(email<span class="op">=</span>email).first()</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> user:</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Responsible.query.filter_by(user_id<span class="op">=</span>user.<span class="bu">id</span>).first()</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_responsible_by_user_id(<span class="va">self</span>, user_id: <span class="bu">int</span>): <span class="co"># 8</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieve a responsible by their user_id (FK para users.id).</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Responsible.query.filter_by(user_id<span class="op">=</span>user_id).first()</span></code></pre></div>
<p><strong>Explicação do
app/services/responsible_service.py</strong>:</p>
<ol type="1">
<li><p><strong>Importações</strong>:</p>
<ul>
<li><code>from app import db</code>: Importa db.</li>
</ul>
<ol type="1">
<li><strong>Importações</strong>:</li>
</ol>
<ul>
<li><code>from app import db</code>: Importa db.</li>
<li><code>from app.models.responsible import Responsible</code>: Importa
o modelo Responsible.</li>
</ul></li>
<li><p><code>class ResponsibleService</code>: Classe de serviço para
responsáveis.</p></li>
<li><p><code>def save(self, responsible: Responsible)</code>: Salva um
objeto Responsible.</p>
<ul>
<li>Este método save inclui tratamento de exceção try/except/rollback e
re-levanta a exceção, o que é uma boa prática. Ele também retorna o
objeto salvo.</li>
</ul></li>
<li><p><code>def get_all_responsibles(self)</code>: Retorna todos os
responsáveis.</p></li>
<li><p><code>def get_responsible_by_id(self, responsible_id: int)</code>:
Busca um responsável pelo seu ID de perfil (Responsible.id).</p></li>
<li><p><code>def get_responsible_by_email(self, email: str)</code>:
Busca um perfil de responsável associado a um usuário com o email
fornecido (similar ao get_caregiver_by_email).</p></li>
<li><p><code>def get_responsible_by_user_id(self, user_id: int)</code>:
Busca um perfil de responsável diretamente pelo user_id (que é a chave
estrangeira na tabela responsible ligando ao users.id). Este método é
mais direto do que get_responsible_by_email se você já tem o
user_id.</p></li>
</ol>
<h4
id="appserviceselderly_service.py"><strong>app/services/elderly_service.py</strong></h4>
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># app/services/elderly_service.py</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app <span class="im">import</span> db <span class="co"># 1</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models.elderly <span class="im">import</span> Elderly <span class="co"># 2</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ElderlyService: <span class="co"># 3</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save(<span class="va">self</span>, elderly: Elderly): <span class="co"># 4</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Save a new elderly to the database.</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>            db.session.add(elderly)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>            db.session.commit()</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> elderly <span class="co"># Retorna o objeto salvo</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>            db.session.rollback()</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;Erro ao salvar no banco de dados: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>) <span class="co"># Log</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="co"># Re-levanta</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_all(<span class="va">self</span>): <span class="co"># 5</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieve all elderly from the database.</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Elderly.query.<span class="bu">all</span>()</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_by_id(<span class="va">self</span>, elderly_id: <span class="bu">int</span>): <span class="co"># 6</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieve an elderly by their ID.</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Elderly.query.get(elderly_id)</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_by_user_id(<span class="va">self</span>, user_id: <span class="bu">int</span>): <span class="co"># 7</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieve an elderly by their user ID.</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="co">        (README: método não utilizado)</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># O modelo Elderly não tem uma FK direta user_id. Ele tem responsible_id.</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Esta função, como está, não funcionaria corretamente para o modelo Elderly atual.</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Se a intenção fosse buscar idosos de um *usuário* (que é um responsável),</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># seria necessário primeiro encontrar o &#39;responsible_id&#39; daquele &#39;user_id&#39;.</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ex: responsible = responsible_service.get_responsible_by_user_id(user_id)</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     if responsible: return Elderly.query.filter_by(responsible_id=responsible.id).all()</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Elderly.query.filter_by(user_id<span class="op">=</span>user_id).first() <span class="co"># Esta linha tentará buscar por uma coluna &#39;user_id&#39; em Elderly, que não existe.</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_by_responsible_id(<span class="va">self</span>, responsible_id: <span class="bu">int</span>): <span class="co"># 8</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a><span class="co">        Retrieve all elderly associated with a specific responsible ID.</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Elderly.query.filter_by(responsible_id<span class="op">=</span>responsible_id).<span class="bu">all</span>()</span></code></pre></div>
<p><strong>Explicação do app/services/elderly_service.py</strong>:</p>
<ol type="1">
<li><p><strong>Importações</strong>:</p>
<ul>
<li><code>from app import db</code>: Importa db.</li>
<li><code>from app.models.elderly import Elderly</code>: Importa o
modelo Elderly.</li>
</ul></li>
<li><p><code>class ElderlyService</code>: Classe de serviço para
idosos.</p></li>
<li><p><code>def save(self, elderly: Elderly)</code>: Salva um objeto
Elderly. Inclui tratamento de exceção.</p></li>
<li><p><code>def get_all(self)</code>: Retorna todos os idosos
cadastrados no sistema.</p></li>
<li><p><code>def get_by_id(self, elderly_id: int)</code>: Busca um idoso
pelo seu ID.</p></li>
<li><p><code>def get_by_user_id(self, user_id: int)</code>:</p>
<ul>
<li><strong>Ponto de Atenção</strong>: O README.md corretamente aponta
que este método não é utilizado. Além disso, o modelo Elderly não possui
um campo user_id. Ele é ligado a um Responsible através de
responsible_id. A query
<code>Elderly.query.filter_by(user_id=user_id).first()</code> resultaria
em erro pois a coluna user_id não existe na tabela elderly. Se a
intenção fosse buscar idosos de um usuário que é um responsável, a
lógica precisaria primeiro obter o ID do perfil Responsible desse
usuário.</li>
</ul></li>
<li><p><code>def get_by_responsible_id(self, responsible_id: int)</code>:
Busca todos os idosos associados a um ID de Responsible específico. Este
método está correto e é usado, por exemplo, na rota
/responsible/my-elderly.</p></li>
</ol>
<p>Os templates são arquivos HTML com marcações especiais do Jinja2 que
permitem exibir dados dinâmicos e criar estruturas de página
reutilizáveis.</p>
<h4
id="apptemplatesbase.html"><strong>app/templates/base.html</strong></h4>
<div class="sourceCode" id="cb34"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="ot"> lang</span><span class="op">=</span><span class="st">&quot;pt-BR&quot;</span><span class="dt">&gt;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> charset</span><span class="op">=</span><span class="st">&quot;UTF-8&quot;</span><span class="dt">&gt;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;viewport&quot;</span><span class="ot"> content</span><span class="op">=</span><span class="st">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="dt">&gt;</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>{% block title %}ProjectCare{% endblock %}<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">link</span><span class="ot"> rel</span><span class="op">=</span><span class="st">&quot;preconnect&quot;</span><span class="ot"> href</span><span class="op">=</span><span class="st">&quot;https://fonts.googleapis.com&quot;</span><span class="dt">&gt;</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">link</span><span class="ot"> href</span><span class="op">=</span><span class="st">&quot;{{ url_for(&#39;static&#39;, filename=&#39;css/style.css&#39;) }}&quot;</span><span class="ot"> rel</span><span class="op">=</span><span class="st">&quot;stylesheet&quot;</span><span class="dt">&gt;</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    {% block extra_css %}{% endblock %}</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    {% include navbar_template %}</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    {% include &#39;fragments/flash.html&#39; %}</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">main</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;fade-in&quot;</span><span class="dt">&gt;</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>        {% block content %}{% endblock %}</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">main</span><span class="dt">&gt;</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    {% include &#39;fragments/footer.html&#39; %}</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;https://unpkg.com/aos@2.3.1/dist/aos.js&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Inicialização do AOS</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;DOMContentLoaded&#39;</span><span class="op">,</span> <span class="kw">function</span>() {</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>            AOS<span class="op">.</span><span class="fu">init</span>({ <span class="dt">duration</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span> <span class="dt">easing</span><span class="op">:</span> <span class="st">&#39;ease-in-out&#39;</span><span class="op">,</span> <span class="dt">once</span><span class="op">:</span> <span class="kw">true</span> })<span class="op">;</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    {% block extra_js %}{% endblock %}</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<p><strong>Explicação do app/templates/base.html:</strong></p>
<ol type="1">
<li><p><code>{% block title %}ProjectCare{% endblock %}</code>: Define
um bloco chamado title. Templates filhos podem sobrescrever este bloco
para definir um título de página específico. Se não for sobrescrito, o
padrão “ProjectCare” será usado.</p></li>
<li><p><code>&lt;link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet"&gt;</code>:
Link para a folha de estilos customizada. url_for(‘static’,
filename=‘…’) é a forma correta no Flask/Jinja2 para gerar URLs para
arquivos estáticos.</p></li>
<li><p><code>{% block extra_css %}{% endblock %}</code>: Bloco para que
templates filhos possam adicionar seus próprios links CSS
específicos.</p></li>
<li><p><code>{% include navbar_template %}</code>: Inclui a barra de
navegação. A variável navbar_template é definida pelo context_processor
inject_user em app/<strong>init</strong>.py, que escolhe entre
fragments/navbar_login.html ou fragments/navbar.html dependendo se o
usuário está logado.</p></li>
<li><p><code>{% include 'fragments/flash.html' %}</code>: Inclui o
template para exibir mensagens flash (mensagens temporárias para o
usuário, como “Login bem-sucedido”).</p></li>
<li><p><code>{% block content %}{% endblock %}</code>: Bloco principal
onde o conteúdo específico de cada página será inserido pelos templates
filhos.</p></li>
<li><p><code>{% include 'fragments/footer.html' %}</code>: Inclui o
rodapé da página.</p></li>
<li><p><code>{% block extra_js %}{% endblock %}</code>: Bloco para que
templates filhos possam adicionar seus próprios scripts
JavaScript.</p></li>
</ol>
<p>Este base.html estabelece uma estrutura consistente para todas as
páginas da aplicação, promovendo a reutilização de código (DRY - Don’t
Repeat Yourself).</p>
<h4
id="apptemplatesfragments"><strong>app/templates/fragments/</strong></h4>
<p><strong>flash.html:</strong></p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>{% with messages = get_flashed_messages(with_categories=True) %} </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>{% if messages %}</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;container mt-3&quot;</span><span class="dt">&gt;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>        {% for category, message in messages %} </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;alert alert-{{ category }} alert-dismissible fade show&quot;</span><span class="ot"> role</span><span class="op">=</span><span class="st">&quot;alert&quot;</span><span class="dt">&gt;</span> </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>            {{ message }}</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;button&quot;</span><span class="ot"> class</span><span class="op">=</span><span class="st">&quot;btn-close&quot;</span><span class="ot"> data-bs-dismiss</span><span class="op">=</span><span class="st">&quot;alert&quot;</span><span class="ot"> aria-label</span><span class="op">=</span><span class="st">&quot;Close&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        {% endfor %}</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>{% endif %}</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>{% endwith %}</span></code></pre></div>
<p><strong>Explicação:</strong> 1.
<code>{% with messages = get_flashed_messages(with_categories=True) %}</code>:
Obtém todas as mensagens flash que foram enviadas pelo backend (ex:
flash(“Mensagem”, “success”)). with_categories=True permite que as
mensagens tenham categorias (ex: ‘success’, ‘danger’, ‘warning’) que
podem ser usadas para estilizar o alerta.</p>
<ol start="2" type="1">
<li><p><code>{% for category, message in messages %}</code>: Itera sobre
as mensagens.</p></li>
<li><p><code>&lt;div class="alert alert-{{ category }} ..."&gt;</code>:
Cria um alerta Bootstrap, usando a category para a classe CSS (ex:
alert-success).</p></li>
</ol>
<p><strong>footer.html:</strong> Contém o HTML para o rodapé do site,
com links rápidos, informações de contato e direitos autorais. Usa
classes Bootstrap e ícones.</p>
<p><strong>navbar.html (para usuários não logados):</strong> - Mostra
links para “Home Care” e “Contato”. - Mostra botões de “Login” e
“Cadastro”. - Usa url_for() para gerar links para as rotas.</p>
<p><strong>navbar_login.html (para usuários logados):</strong> - Similar
à navbar.html, mas em vez de botões de Login/Cadastro: - Mostra um badge
indicando o perfil ativo (session[‘acting_profile’]). - Link “Meus
Perfis” (url_for(‘login.select_acting_profile’)) para permitir a troca
de perfil de atuação (se o usuário tiver mais de um). - Botão “Sair”
(url_for(‘home.logout’)). <strong>Ponto de Atenção</strong>: Como
discutido, há duas rotas de logout. Esta navbar aponta para a de
home.py.</p>
<h4 id="outros-templates-significativos"><strong>Outros Templates
Significativos:</strong></h4>
<p><strong>home/home.html:</strong> - Usa
<code>{% extends 'base.html' %}</code>. - Seção “Hero” proeminente. -
<strong>Conteúdo Condicional</strong>: Exibe diferentes seções
dependendo se o usuário está logado (session.get(‘user_id’)) e qual o
seu acting_profile (‘caregiver’ ou ‘responsible’). -
<strong>Cuidador</strong>: Links para “Encontre Oportunidades”
(caregivers.list_elderly) e “Atualizar Perfil” (link # atualmente,
precisaria de uma rota). - <strong>Responsável</strong>: Links para
“Meus Idosos” (responsible_dashboard.my_elderly), “Cadastrar Idoso”
(register.register_elderly), e “Encontrar Cuidadores”
(caregivers.list_caregivers). - <strong>Não Logado</strong>: Seções “Por
que escolher a ProjectCare?”, “Profissionais em Destaque”, “O que nossos
clientes dizem”, e um CTA para cadastro/contato. - Usa a biblioteca AOS
para animações (data-aos=“…”).</p>
<p><strong>login/login.html:</strong> - Formulário de login com campos
para email e senha. - Submete para url_for(‘login.login’) via método
POST. - Inclui link para “Esqueceu a senha?” (atualmente #) e “Crie uma
conta” (url_for(‘register.register’)). - JavaScript para alternar
visibilidade da senha e validação de formulário Bootstrap.</p>
<p><strong>login/select_acting_profile.html:</strong> - Permite que
usuários com ambos os perfis escolham como querem atuar. - Formulário
com dois botões, um para “Acessar como Cuidador” (value=“caregiver”) e
outro para “Acessar como Responsável” (value=“responsible”).</p>
<p><strong>register/register.html:</strong> - Formulário extenso para
cadastro de um novo User com informações pessoais, endereço e de acesso.
- Campos incluem nome, CPF, telefone, data de nascimento, gênero,
endereço, email, senha. - JavaScript para máscaras de CPF e telefone,
alternador de visibilidade de senha e validação de confirmação de
senha.</p>
<p><strong>register/select.html:</strong> - Exibido após o cadastro do
User. - Mostra informações do usuário recém-cadastrado. - Oferece botões
para “Registrar como Cuidador” (url_for(‘register.register_caregiver’))
e “Registrar como Responsável”
(url_for(‘register.register_responsible’)).</p>
<p><strong>register/register_caregiver.html,
register/register_responsible.html,
register/register_elderly.html:</strong> - Formulários específicos para
coletar dados para os perfis de Cuidador, Responsável e para o cadastro
de Idosos, respectivamente. - Estruturados com seções claras e campos de
entrada apropriados. register_caregiver.html usa checkboxes para dias e
períodos de disponibilidade.</p>
<p><strong>list/caregiver_list.html, list/elderly_list.html,
list/my_elderly_list.html:</strong> - Templates para exibir listas de
dados. - Usam loops Jinja (<code>{% for item in items %}</code>) para
iterar sobre os dados passados pelo controlador. - Exibem os dados em
tabelas (caregivers) ou cards (elderly). - Incluem links para “Ver
Detalhes” (atualmente #, precisariam de rotas específicas para detalhes
de cada item). - my_elderly_list.html tem um botão para “Adicionar Novo
Idoso”.</p>
<p><strong>contact/contact.html:</strong> - Apresenta informações de
contato (endereço, telefone, email). - Inclui um formulário de contato.
Como mencionado, a rota backend para processar este formulário via POST
não está implementada em app/routes/contact.py. - Mostra informações
sobre a equipe (desenvolvedores do projeto) e sobre o projeto. - Inclui
um mapa (o iframe src está como placeholder e não exibirá um mapa real
sem uma URL válida do Google Maps Embed API).</p>
<p>Os templates estão bem organizados em subdiretórios e fazem bom uso
do Bootstrap para layout e estilo, e da biblioteca AOS para animações. A
herança de base.html e o uso de fragmentos promovem a consistência
visual e a reutilização.</p>
<h3 id="arquivos-estáticos-appstatic"><strong>5.6. Arquivos Estáticos
(app/static/)</strong></h3>
<p>Esta pasta contém arquivos que são servidos diretamente ao navegador,
sem processamento pelo Flask (além de gerar a URL para eles).</p>
<h4 id="cssstyle.css"><strong>css/style.css:</strong></h4>
<p>Este arquivo contém os estilos CSS personalizados para o ProjectCare,
complementando o Bootstrap.</p>
<ol type="1">
<li><strong>Paleta de Cores</strong>: Define variáveis CSS (:root) para
cores primárias (azuis/teals), secundárias (laranjas), neutras e de
status (sucesso, aviso, perigo). Isso é uma excelente prática para
manter a consistência visual e facilitar alterações de tema.</li>
</ol>
<div class="sourceCode" id="cb36"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="in">:root</span> {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">--primary-color</span><span class="ch">:</span> <span class="cn">#2c7da0</span><span class="op">;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">--secondary-color</span><span class="ch">:</span> <span class="cn">#f4a261</span><span class="op">;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* ... outras variáveis ... */</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ol start="2" type="1">
<li><p><strong>Tipografia</strong>: Define fontes Nunito (sans-serif) e
Lora (serif) do Google Fonts.</p></li>
<li><p><strong>Estilos Base</strong>: Estilos para body, cabeçalhos
(h1-h6), links (a).</p></li>
<li><p><strong>Componentes Customizados</strong>: Estilos para botões
(.btn), cards (.card), navbar (.navbar), footer (footer), formulários
(.form-control). Muitos desses estilos adicionam ou modificam os estilos
padrão do Bootstrap, como bordas arredondadas, sombras e
transições.</p></li>
<li><p><strong>Seções Específicas</strong>: Estilos para a seção “hero”
(.hero-section), cards de features (.feature-card), cards de perfil
(.profile-card), seções de dashboard (.dashboard-section).</p></li>
<li><p><strong>Animações</strong>: Classe .fade-in simples. A biblioteca
AOS é usada para animações de scroll mais complexas, inicializada em
base.html.</p></li>
<li><p><strong>Responsividade</strong>: Inclui um bloco <span
class="citation" data-cites="media">@media</span> (max-width: 768px)
para ajustes em telas menores, como o padding da hero section e tamanho
de fontes.</p></li>
</ol>
<p>O CSS é moderno e bem estruturado, utilizando variáveis CSS para
facilitar a manutenção.</p>
<h4 id="images"><strong>images/:</strong></h4>
<p>Esta pasta, conforme indicado pela estrutura do projeto no README.md
e pelo uso em templates como contact.html (images/breno.jpg,
images/felipe.jpg) e footer.html (images/projectcare.png), armazena as
imagens usadas na interface da aplicação.</p>
<h3 id="migrações-migrations"><strong>5.7. Migrações
(migrations/)</strong></h3>
<p>Esta pasta é gerenciada pelo Flask-Migrate (usando Alembic por baixo
dos panos) para lidar com alterações no esquema do seu banco de dados ao
longo do tempo.</p>
<h4 id="alembic.ini"><strong>alembic.ini:</strong></h4>
<p>Arquivo de configuração do Alembic. Define como o Alembic se conecta
ao banco, onde encontrar os scripts de migração, logging, etc. A linha
sqlalchemy.url é preenchida dinamicamente por env.py.</p>
<h4 id="env.py"><strong>env.py:</strong></h4>
<p>Script de ambiente do Alembic. É executado quando você roda comandos
flask db ….</p>
<ul>
<li>Configura o contexto de migração, obtendo a URL do banco de dados e
os metadados (schema) dos seus modelos SQLAlchemy a partir da aplicação
Flask.</li>
<li>Contém lógica para executar migrações no modo “offline” (gerando um
script SQL) ou “online” (conectando-se diretamente ao banco para aplicar
as alterações).</li>
<li>Inclui uma função process_revision_directives para evitar a geração
de migrações vazias se o schema não mudou.</li>
</ul>
<h4 id="versions"><strong>versions/:</strong></h4>
<p>Esta subpasta contém os scripts de migração individuais. Cada script
representa uma alteração no esquema do banco.</p>
<p><strong>3d3dbbf32321_criação_inicial.py:</strong> -
<code>revision = '3d3dbbf32321'</code> e
<code>down_revision = None</code>: Identificadores da migração. Sendo a
primeira, não tem down_revision. - <code>def upgrade()</code>: Contém os
comandos do Alembic (op.create_table, op.add_column, etc.) para aplicar
as alterações desta versão ao banco. Neste caso, cria todas as tabelas
iniciais (users, caregiver, responsible, contract, elderly) com suas
colunas e chaves estrangeiras, conforme definido nos seus modelos no
momento da criação desta migração. - <code>def downgrade()</code>:
Contém os comandos para reverter as alterações feitas por upgrade().
Neste caso, op.drop_table para todas as tabelas criadas.</p>
<p><strong>88e77b6b2ef9_aumentar_tamanho_de_textos_em_caregivers.py:</strong>
- <code>revision = '88e77b6b2ef9'</code> e
<code>down_revision = '3d3dbbf32321'</code>: Esta migração depende da
anterior. - <code>def upgrade()</code>: Altera a coluna skills da tabela
caregiver de VARCHAR(200) para VARCHAR(500). Usa op.batch_alter_table
que é recomendado para operações que podem não ser suportadas em todos
os backends de banco de dados (especialmente SQLite) sem um “batch
mode”. - <code>def downgrade()</code>: Reverte a alteração, mudando
skills de volta para VARCHAR(200).</p>
<p>O sistema de migrações é essencial para evoluir o banco de dados de
forma controlada e versionada, especialmente em ambientes de equipe ou
quando se faz deploy para produção.</p>
<h3 id="arquivos-raiz"><strong>5.8. Arquivos Raiz</strong></h3>
<h4 id="requirements.txt"><strong>requirements.txt:</strong></h4>
<ul>
<li>Lista todas as dependências Python do projeto com suas versões
exatas.</li>
<li>Gerado tipicamente com
<code>pip freeze &gt; requirements.txt</code>.</li>
<li>Permite que outros desenvolvedores (ou o ambiente de deploy)
instalem exatamente as mesmas versões das bibliotecas usando
<code>pip install -r requirements.txt</code>, garantindo consistência do
ambiente.</li>
<li>Inclui Flask, SQLAlchemy, Flask-Migrate, Argon2, psycopg2-binary,
Jinja2, python-dotenv, Werkzeug, e outras dependências dessas
bibliotecas.</li>
</ul>
<h4 id="vercel.json"><strong>vercel.json:</strong></h4>
<p>Arquivo de configuração para a plataforma de deploy Vercel.</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Versão</span> <span class="er">da</span> <span class="er">especificação</span> <span class="er">de</span> <span class="er">configuração</span> <span class="er">da</span> <span class="er">Vercel</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;builds&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="er">//</span> <span class="er">Define</span> <span class="er">como</span> <span class="er">o</span> <span class="er">projeto</span> <span class="er">é</span> <span class="er">construído</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">{</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;src&quot;</span><span class="fu">:</span> <span class="st">&quot;app/run.py&quot;</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Arquivo</span> <span class="er">de</span> <span class="er">entrada</span> <span class="er">para</span> <span class="er">o</span> <span class="er">build</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;use&quot;</span><span class="fu">:</span> <span class="st">&quot;@vercel/python&quot;</span> <span class="er">//</span> <span class="er">Builder</span> <span class="er">a</span> <span class="er">ser</span> <span class="er">usado</span> <span class="er">(para</span> <span class="er">Python)</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;routes&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="er">//</span> <span class="er">Define</span> <span class="er">como</span> <span class="er">as</span> <span class="er">requisições</span> <span class="er">são</span> <span class="er">roteadas</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">{</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;src&quot;</span><span class="fu">:</span> <span class="st">&quot;/(.*)&quot;</span><span class="fu">,</span> <span class="er">//</span> <span class="er">Padrão</span> <span class="er">que</span> <span class="er">casa</span> <span class="er">com</span> <span class="er">qualquer</span> <span class="er">caminho</span> <span class="er">de</span> <span class="er">URL</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;dest&quot;</span><span class="fu">:</span> <span class="st">&quot;app/run.py&quot;</span> <span class="er">//</span> <span class="er">Redireciona</span> <span class="er">todas</span> <span class="er">as</span> <span class="er">requisições</span> <span class="er">para</span> <span class="er">o</span> <span class="er">entrypoint</span> <span class="er">da</span> <span class="er">aplicação</span> <span class="er">Flask</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Este arquivo instrui a Vercel a usar o runtime Python e a tratar
app/run.py como o ponto de entrada da aplicação WSGI. Todas as
requisições recebidas pela Vercel são encaminhadas para este script.</p>
<h4 id="env-não-fornecido-mas-crucial"><strong>.env (Não fornecido, mas
crucial):</strong></h4>
<p>Como descrito no README.md e usado em app/<strong>init</strong>.py,
este arquivo (que não deve ser versionado no Git por conter segredos)
armazena variáveis de ambiente como SECRET_KEY e DATABASE_URL.</p>
<h4
id="config.py-mencionado-na-estrutura-do-readme.md-mas-não-fornecido"><strong>config.py
(Mencionado na estrutura do README.md, mas não fornecido):</strong></h4>
<p>Se existisse, poderia conter outras configurações da aplicação, como
caminhos, chaves de API de terceiros, etc. No projeto atual, as
principais configurações (SECRET_KEY, DATABASE_URL) são carregadas via
variáveis de ambiente (arquivo .env ou configuradas diretamente na
Vercel).</p>
<h2 id="autenticação-e-gerenciamento-de-sessão"><strong>6. Autenticação
e Gerenciamento de Sessão</strong></h2>
<p>Conforme descrito no README.md e observado no código.</p>
<h3 id="autenticação-1"><strong>6.1. Autenticação</strong></h3>
<ol type="1">
<li><p><strong>Formulário de Login</strong>: O usuário insere email e
senha na página /login/ (template login/login.html).</p></li>
<li><p><strong>Processamento da Rota</strong>: A rota login() em
app/routes/login.py recebe os dados.</p></li>
<li><p><strong>Verificação de Credenciais</strong>:</p>
<ul>
<li>O serviço user_service.get_by_email(email) é chamado para encontrar
o usuário.</li>
<li><strong>FALHA CRÍTICA</strong>: Como mencionado antes, a rota
login() não chama user.check_password(password) após encontrar o
usuário. Ela precisa verificar se a senha fornecida corresponde ao hash
armazenado usando o método check_password(password) do modelo User.</li>
</ul></li>
<li><p><strong>Gerenciamento de Sessão</strong>: Se as credenciais
fossem válidas (após correção):</p>
<ul>
<li>session[‘user_id’] = user.id é definido, marcando o usuário como
autenticado.</li>
</ul></li>
<li><p><strong>Seleção de Perfil</strong>: O sistema verifica os perfis
(Caregiver, Responsible) associados ao User.</p>
<ul>
<li>Se ambos existem, redireciona para
/login/select-acting-profile.</li>
<li>Se apenas um existe, ele é definido em
session[‘acting_profile’].</li>
<li>Se nenhum perfil existe, redireciona para
/register/select-profile.</li>
</ul></li>
</ol>
<h3 id="segurança-de-senhas-1"><strong>6.2. Segurança de
Senhas</strong></h3>
<p>As senhas são tratadas pelo modelo User em app/models/user.py.</p>
<h4 id="hashing-com-argon2"><strong>Hashing com Argon2:</strong></h4>
<ul>
<li>Quando um usuário é criado ou a senha é alterada, o método
user.set_password(password) é chamado.</li>
<li>Este método usa a instância ph (um PasswordHasher do Argon2) para
gerar um hash da senha: self.password_hash = ph.hash(password).</li>
<li>O Argon2 é uma escolha robusta e recomendada para hashing de senhas,
com parâmetros configuráveis para time_cost, memory_cost, e parallelism
para ajustar a força do hash.</li>
<li>Durante o login, o método user.check_password(password) deve ser
chamado.</li>
<li>Ele usa ph.verify(self.password_hash, password) para comparar a
senha fornecida com o hash armazenado. Retorna True se corresponder,
False caso contrário (capturando VerifyMismatchError).</li>
</ul>
<h3 id="gerenciamento-de-sessão"><strong>6.3. Gerenciamento de
Sessão</strong></h3>
<ul>
<li>A sessão do Flask (acessível via objeto session importado de flask)
é usada para armazenar informações do usuário entre requisições.</li>
<li><strong>session[‘user_id’]</strong>: Armazena o ID do usuário
autenticado. Sua presença indica que o usuário está logado.</li>
<li><strong>Context Processor inject_user</strong>: Definido em
app/<strong>init</strong>.py, esta função injeta a variável
navbar_template no contexto de todos os templates. O valor de
navbar_template (fragments/navbar_login.html ou fragments/navbar.html) é
determinado pela presença de user_id na sessão. Isso permite que o
base.html inclua dinamicamente a barra de navegação correta.</li>
</ul>
<h2 id="interface-do-usuário-frontend"><strong>7. Interface do Usuário
(Frontend)</strong></h2>
<p>Detalhes baseados no README.md e na análise dos templates e CSS.</p>
<h3 id="estrutura-de-templates"><strong>7.1. Estrutura de
Templates</strong></h3>
<p>A aplicação usa o motor de templates Jinja2 com uma estrutura
hierárquica:</p>
<ol type="1">
<li><p><strong>base.html</strong>: O template principal que define a
estrutura HTML comum (doctype, head, body, inclusão de CSS/JS globais,
footer). Outros templates herdam dele usando
<code>{% extends 'base.html' %}</code>. Ele define blocos
(<code>{% block title %}</code>, <code>{% block content %}</code>,
<code>{% block extra_css %}</code>, <code>{% block extra_js %}</code>)
que podem ser sobrescritos pelos templates filhos.</p></li>
<li><p><strong>Fragmentos Reutilizáveis
(app/templates/fragments/)</strong>:</p>
<ul>
<li><strong>navbar.html</strong>: Barra de navegação para usuários não
autenticados.</li>
<li><strong>navbar_login.html</strong>: Barra de navegação para usuários
autenticados, com opções de perfil e logout.</li>
<li><strong>footer.html</strong>: Rodapé comum a todas as páginas.</li>
<li><strong>flash.html</strong>: Para exibir mensagens flash (alertas
temporários).</li>
<li>São incluídos nos templates usando
<code>{% include 'path/to/fragment.html' %}</code>.</li>
</ul></li>
<li><p><strong>Templates Específicos</strong>: Organizados em
subdiretórios como home/, login/, register/, list/, contact/ para cada
funcionalidade ou seção da aplicação.</p></li>
</ol>
<h3 id="tecnologias-frontend"><strong>7.2. Tecnologias
Frontend</strong></h3>
<ol type="1">
<li><p><strong>Bootstrap 5.3.3</strong>: Usado extensivamente para
layout responsivo (sistema de grid, componentes como cards, botões,
formulários, navbar, alertas) e estilo base.</p></li>
<li><p><strong>Google Fonts</strong>: Nunito (sans-serif) e Lora (serif)
são importadas em base.html e definidas no style.css.</p></li>
<li><p><strong>Bootstrap Icons</strong>: Biblioteca de ícones SVG,
também importada em base.html e usada em vários templates (ex: bi
bi-house-heart).</p></li>
<li><p><strong>AOS Animation Library</strong>: Biblioteca JavaScript
para animações de elementos ao rolar a página (“Animate On Scroll”).
Inicializada em base.html. Os atributos data-aos são usados nos
elementos HTML para aplicar os efeitos (ex: data-aos=“fade-up” em
home.html).</p></li>
<li><p><strong>CSS Customizado (static/css/style.css)</strong>:</p>
<ul>
<li>Define variáveis CSS para uma paleta de cores coesa e
tipografia.</li>
<li>Customiza e estende estilos do Bootstrap.</li>
<li>Adiciona estilos específicos para seções como “hero”, “feature
cards”, “profile cards”.</li>
<li>Inclui media queries básicas para responsividade.</li>
</ul></li>
</ol>
<p>O frontend parece moderno, limpo e responsivo, fazendo bom uso das
tecnologias escolhidas.</p>
<h2 id="fluxos-de-usuário-chave"><strong>8. Fluxos de Usuário
Chave</strong></h2>
<p>Descritos no README.md e mapeados para o código:</p>
<h3 id="registro-de-novo-usuário"><strong>8.1. Registro de Novo
Usuário</strong></h3>
<ol type="1">
<li><p><strong>Acesso</strong>: Usuário acessa /register/ (rota
register() em app/routes/register.py). Template:
register/register.html.</p></li>
<li><p><strong>Preenchimento</strong>: Informações pessoais, endereço,
email, senha.</p></li>
<li><p><strong>Validação e Criação</strong>: A rota register():</p>
<ul>
<li>Verifica se o usuário já existe
(user_service.get_by_email_or_phone_or_cpf).</li>
<li>Cria uma instância de User e salva (user_service.save).</li>
<li>session[‘user_id’] é definido.</li>
</ul></li>
<li><p><strong>Seleção de Perfil</strong>: Redirecionado para
/register/select-profile (rota select_profile()). Template:
register/select.html.</p></li>
<li><p><strong>Escolha do Perfil</strong>: Usuário clica para registrar
como Cuidador ou Responsável.</p></li>
<li><p><strong>Formulário Específico do Perfil</strong>:</p>
<ul>
<li><strong>Cuidador</strong>: Redirecionado para /register/caregiver
(rota register_caregiver()). Template:
register/register_caregiver.html.</li>
<li><strong>Responsável</strong>: Redirecionado para
/register/responsible (rota register_responsible()). Template:
register/register_responsible.html.</li>
</ul></li>
<li><p><strong>Criação do Perfil</strong>: O perfil (Caregiver ou
Responsible) é criado e associado ao User. session[‘acting_profile’] é
definido.</p></li>
<li><p><strong>Redirecionamento</strong>: Usuário é redirecionado para a
página inicial (home.home) com o perfil ativo.</p></li>
</ol>
<h3 id="login-e-seleção-de-perfil"><strong>8.2. Login e Seleção de
Perfil</strong></h3>
<ol type="1">
<li><p><strong>Acesso</strong>: Usuário acessa /login/ (rota login() em
app/routes/login.py). Template: login/login.html.</p></li>
<li><p><strong>Preenchimento</strong>: Email e senha.</p></li>
<li><p><strong>Validação</strong>: Rota login():</p>
<ul>
<li>Busca usuário por email (user_service.get_by_email).</li>
<li><strong>(NECESSÁRIO CORRIGIR)</strong> Deve verificar a senha com
user.check_password(password).</li>
</ul></li>
<li><p><strong>Verificação de Perfis</strong>:</p>
<ul>
<li>Se as credenciais forem válidas, busca perfis Caregiver e
Responsible associados.</li>
<li><strong>Se nenhum perfil</strong>: Redireciona para
/register/select-profile (rota select_profile()).</li>
<li><strong>Se ambos os perfis</strong>: Redireciona para
/login/select-acting-profile (rota select_acting_profile()). Template:
login/select_acting_profile.html. O usuário escolhe o perfil e
session[‘acting_profile’] é definido.</li>
<li><strong>Se apenas um perfil</strong>: session[‘acting_profile’] é
definido automaticamente.</li>
</ul></li>
<li><p><strong>Redirecionamento</strong>: Usuário é redirecionado para a
página inicial (home.home) com o perfil ativo.</p></li>
</ol>
<h3 id="cadastro-de-idoso-para-responsáveis"><strong>8.3. Cadastro de
Idoso (para Responsáveis)</strong></h3>
<ol type="1">
<li><p><strong>Acesso</strong>: Usuário com perfil de Responsável ativo
acessa /register/elderly (rota register_elderly() em
app/routes/register.py). Template: register/register_elderly.html.</p>
<ul>
<li>A rota verifica se session.get(‘acting_profile’) ==
‘responsible’.</li>
</ul></li>
<li><p><strong>Preenchimento</strong>: Formulário com informações
detalhadas do idoso.</p></li>
<li><p><strong>Validação e Criação</strong>: Rota
register_elderly():</p>
<ul>
<li>Obtém o objeto Responsible do usuário logado.</li>
<li>Cria uma instância de Elderly com os dados do formulário e o associa
ao Responsible.</li>
<li>Salva o Elderly (elderly_service.save).</li>
</ul></li>
<li><p><strong>Confirmação</strong>: Mensagem flash de sucesso e
redirecionamento (ex: para a lista de idosos do responsável,
/responsible/my-elderly).</p></li>
</ol>
<h2 id="deploy-vercel"><strong>9. Deploy (Vercel)</strong></h2>
<p>A aplicação está configurada para deploy na plataforma Vercel.</p>
<h4 id="configuração-vercel.json"><strong>Configuração
(vercel.json)</strong></h4>
<div class="sourceCode" id="cb38"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;builds&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">{</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;src&quot;</span><span class="fu">:</span> <span class="st">&quot;app/run.py&quot;</span><span class="fu">,</span>      <span class="er">//</span> <span class="er">Arquivo</span> <span class="er">de</span> <span class="er">entrada</span> <span class="er">para</span> <span class="er">o</span> <span class="er">build</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;use&quot;</span><span class="fu">:</span> <span class="st">&quot;@vercel/python&quot;</span>   <span class="er">//</span> <span class="er">Especifica</span> <span class="er">o</span> <span class="er">builder</span> <span class="er">Python</span> <span class="er">da</span> <span class="er">Vercel</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;routes&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">{</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;src&quot;</span><span class="fu">:</span> <span class="st">&quot;/(.*)&quot;</span><span class="fu">,</span>           <span class="er">//</span> <span class="er">Captura</span> <span class="er">todas</span> <span class="er">as</span> <span class="er">rotas</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;dest&quot;</span><span class="fu">:</span> <span class="st">&quot;app/run.py&quot;</span>      <span class="er">//</span> <span class="er">Direciona</span> <span class="er">todas</span> <span class="er">as</span> <span class="er">requisições</span> <span class="er">para</span> <span class="er">o</span> <span class="er">script</span> <span class="er">app/run.py</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Este arquivo instrui a Vercel sobre como construir e servir a
aplicação Python/Flask.</p>
<h4 id="ponto-de-entrada-apprun.py"><strong>Ponto de Entrada
(app/run.py)</strong></h4>
<ul>
<li>O script app/run.py cria a instância da aplicação Flask chamando
create_app() de app/<strong>init</strong>.py.</li>
<li>A Vercel usa este script para iniciar o servidor WSGI que executa a
aplicação Flask.</li>
</ul>
<h4 id="variáveis-de-ambiente"><strong>Variáveis de
Ambiente</strong></h4>
<p>Conforme o README.md, as seguintes variáveis de ambiente precisam ser
configuradas na Vercel:</p>
<ul>
<li><strong>SECRET_KEY</strong>: Chave secreta da aplicação.</li>
<li><strong>DATABASE_URL</strong>: URL de conexão com o banco de dados
PostgreSQL (provavelmente um serviço de banco de dados na nuvem, como
Neon, Supabase, ou AWS RDS, compatível com PostgreSQL).</li>
</ul>
<h2 id="pontos-de-atenção-e-oportunidades-de-melhoria"><strong>10.
Pontos de Atenção e Oportunidades de Melhoria</strong></h2>
<p>Com base na análise do README.md e do código fornecido:</p>
<p><strong>Já Mencionados no README.md (Possíveis Melhorias e Próximos
Passos):</strong></p>
<h4 id="funcionalidades"><strong>Funcionalidades:</strong></h4>
<ul>
<li>Sistema de Avaliações.</li>
<li>Mensagens Diretas.</li>
<li>Calendário de Disponibilidade (mais interativo que os campos
atuais).</li>
<li>Integração de Pagamentos.</li>
<li>Notificações (email/push).</li>
</ul>
<h4 id="técnicas"><strong>Técnicas:</strong></h4>
<ul>
<li><strong>Testes Automatizados</strong>: Essencial para garantir a
qualidade e facilitar refatorações. (Unitários, Integração).</li>
<li><strong>API RESTful</strong>: Para futuras integrações (ex: app
mobile).</li>
<li><strong>Refatoração de Serviços</strong>: Padronizar a abordagem
(funcional vs. classe). user_service.py é funcional, enquanto os outros
são classes.</li>
<li><strong>Cache</strong>: Para otimizar desempenho em consultas
frequentes.</li>
<li><strong>Monitoramento e Logging Avançado</strong>: Ferramentas para
acompanhar a saúde da aplicação em produção.</li>
<li><strong>Documentação de API</strong>: (Se API for implementada) Usar
Swagger/OpenAPI.</li>
</ul>
<h4 id="segurança"><strong>Segurança:</strong></h4>
<ul>
<li><strong>Autenticação de Dois Fatores (2FA)</strong>.</li>
<li><strong>Rate Limiting</strong> (para prevenir força bruta, DDOS em
endpoints específicos).</li>
<li><strong>CSRF Protection</strong>: Flask-WTF (que está nos
requirements.txt) pode ajudar com isso, mas precisa ser implementado nos
formulários. Verifique se todos os formulários POST estão
protegidos.</li>
<li><strong>Verificação de Email</strong> (durante o registro).</li>
<li><strong>Logs de Auditoria</strong> para ações sensíveis.</li>
</ul>
<h4 id="observações-adicionais-da-análise-do-código"><strong>Observações
Adicionais da Análise do Código:</strong></h4>
<ol type="1">
<li><strong>Falha de Segurança no Login</strong>:
<ul>
<li><strong>CRÍTICO</strong>: A rota login() em app/routes/login.py não
verifica a senha do usuário. Atualmente, qualquer pessoa pode logar com
qualquer email cadastrado sem fornecer a senha correta. É urgente
adicionar a chamada user.check_password(password).</li>
</ul></li>
<li><strong>Registro do user_bp</strong>:
<ul>
<li>O Blueprint user_bp definido em app/routes/user.py não está sendo
registrado em app/<strong>init</strong>.py. Suas rotas (ex:
/user/profiles) não estarão acessíveis.</li>
</ul></li>
<li><strong>Consistência nas Rotas de Logout</strong>:
<ul>
<li>Existem duas rotas de logout: /logout em home.py e /login/logout em
login.py. A navbar_login.html aponta para home.logout. Seria bom
consolidar em uma rota, preferencialmente /logout ou /auth/logout e
garantir que limpe a sessão completamente (user_id e acting_profile) e
forneça feedback ao usuário. O README.md refere-se a /login/logout.</li>
</ul></li>
<li><strong>Tratamento de Erros nos Serviços</strong>:
<ul>
<li>Nem todos os métodos save nos serviços têm blocos
try/except/rollback para db.session.commit(). Isso foi observado no
caregiver_service.py e no user_service.py (o save do user_service tem um
try/except, mas poderia ser mais específico para IntegrityError).</li>
</ul></li>
<li><strong>Validação e Conversão de Dados nas Rotas</strong>:
<ul>
<li>A conversão de birthdate de string para objeto date no registro de
User e Elderly deve ser feita explicitamente antes de passar para o
construtor do modelo ou serviço, para maior robustez. (SQLAlchemy pode
lidar com strings ISO, mas a conversão explícita é mais segura).</li>
<li>A conversão de experience para int e pretensao para float na rota
register_caregiver é uma boa prática.</li>
</ul></li>
<li><strong>Lógica de Filtro em
user_service.get_by_email_or_phone_or_cpf</strong>:
<ul>
<li>A implementação atual usa AND implícito. Se a intenção é OR (como
parece ser o caso para a verificação de unicidade no registro), a query
precisa ser ajustada usando sqlalchemy.or_.</li>
</ul></li>
<li><strong>Método elderly_service.get_by_user_id</strong>:
<ul>
<li>Este método tenta filtrar Elderly por uma coluna user_id que não
existe no modelo Elderly. Conforme o README.md, ele não é usado. Se for
necessário no futuro, precisará ser corrigido para usar responsible_id
após buscar o Responsible pelo user_id.</li>
</ul></li>
<li><strong>Processamento do Formulário de Contato</strong>:
<ul>
<li>A rota /contact/ em app/routes/contact.py só lida com GET. O
README.md e o template contact.html sugerem que deveria haver
processamento POST, que não está implementado.</li>
</ul></li>
<li><strong>Uso de db.create_all() com Migrações</strong>:
<ul>
<li>A chamada db.create_all() em app/<strong>init</strong>.py pode ser
redundante ou potencialmente problemática se as migrações do Alembic são
a principal forma de gerenciar o schema do banco após a configuração
inicial. Normalmente, em um projeto com Flask-Migrate, as migrações
(flask db upgrade) cuidam da criação e atualização das tabelas.</li>
</ul></li>
<li><strong>Armazenamento de skills e Informações de Disponibilidade do
Cuidador</strong>:
<ul>
<li>Na rota register_caregiver, informações como dias disponíveis,
períodos e início imediato são concatenadas na string skills_full. O
modelo Caregiver já possui campos separados para dias_disponiveis,
periodos_disponiveis, inicio_imediato. Seria mais limpo e estruturado
usar esses campos diretamente, em vez de adicionar essa informação
também ao campo skills. A query atual do código está correta ao popular
os campos separados do modelo, mas a concatenação em skills_full parece
redundante.</li>
</ul></li>
<li><strong>Redirecionamentos e Feedback ao Usuário (Flash
Messages)</strong>:
<ul>
<li>Algumas rotas poderiam ter redirecionamentos mais específicos ou
mensagens flash mais informativas (ex: após logout, ao tentar acessar
páginas não autorizadas).</li>
</ul></li>
<li><strong>Links “Ver Detalhes” nos Templates de Lista</strong>:
<ul>
<li>Nos templates caregiver_list.html, elderly_list.html, e
my_elderly_list.html, os links/botões “Ver Detalhes” atualmente apontam
para #. Seria necessário implementar rotas e templates para exibir os
detalhes de um cuidador ou idoso específico. O README.md menciona rotas
como /caregivers/<int:caregiver_id> e
/responsible/elderly/<int:elderly_id>, que precisariam ser
implementadas.</li>
</ul></li>
<li><strong>Consistência na Busca de Perfis Vinculados a User</strong>:
<ul>
<li>Em várias rotas (login.py, user.py), os perfis Caregiver e
Responsible são buscados primeiro por ID e depois por email como
fallback. Se os relacionamentos user.caregiver e user.responsible no
modelo User estiverem corretamente configurados e carregados (o que
uselist=False sugere ser um objeto direto), acessar user.caregiver e
user.responsible após obter o objeto user seria mais direto e
eficiente.</li>
</ul></li>
</ol>
<h2 id="glossário-de-termos-técnicos"><strong>11. Glossário de Termos
Técnicos</strong></h2>
<p><strong>Flask</strong>: Um microframework para desenvolvimento web em
Python, conhecido por sua simplicidade e extensibilidade.</p>
<p><strong>SQLAlchemy</strong>: Uma biblioteca Python que fornece um ORM
(Object-Relational Mapper) e um SQL toolkit, permitindo interagir com
bancos de dados usando objetos Python.</p>
<p><strong>ORM (Object-Relational Mapper)</strong>: Técnica que mapeia
objetos de uma linguagem de programação para tabelas em um banco de
dados relacional, permitindo que o desenvolvedor manipule dados do banco
usando código orientado a objetos.</p>
<p><strong>PostgreSQL</strong>: Um sistema de gerenciamento de banco de
dados relacional objeto, robusto e de código aberto.</p>
<p><strong>Jinja2</strong>: Um motor de templates para Python, usado
pelo Flask para renderizar páginas HTML dinamicamente, inserindo dados
do backend nos templates.</p>
<p><strong>Blueprint (Flask)</strong>: Uma forma de organizar uma
aplicação Flask em componentes menores e reutilizáveis. Cada blueprint
pode ter suas próprias rotas, templates e arquivos estáticos.</p>
<p><strong>Migrações (Alembic/Flask-Migrate)</strong>: Processo de
gerenciar e aplicar alterações ao esquema de um banco de dados de forma
versionada e controlada.</p>
<p><strong>Argon2</strong>: Um algoritmo de hashing de senha moderno e
seguro, projetado para ser resistente a ataques de força bruta e outros
tipos de ataques.</p>
<p><strong>Variáveis de Ambiente</strong>: Variáveis configuradas fora
do código da aplicação (ex: no sistema operacional ou em um arquivo
.env) que podem alterar o comportamento da aplicação (ex: chaves
secretas, URLs de banco de dados).</p>
<p><strong>Deploy</strong>: O processo de disponibilizar uma aplicação
para os usuários finais, geralmente hospedando-a em um servidor ou
plataforma de nuvem como a Vercel.</p>
<p><strong>API (Application Programming Interface)</strong>: Um conjunto
de regras e protocolos que permite que diferentes softwares se
comuniquem entre si. Uma API RESTful é um tipo comum de API para web
services.</p>
<p><strong>CSRF (Cross-Site Request Forgery)</strong>: Um tipo de ataque
em que um usuário autenticado é induzido a executar uma ação indesejada
em uma aplicação web.</p>
<p><strong>CRUD</strong>: Acrônimo para Create, Read, Update, Delete, as
quatro operações básicas de persistência de dados.</p>
<p><strong>Sessão (Web)</strong>: Um mecanismo para armazenar
informações sobre um usuário específico através de múltiplas requisições
HTTP, permitindo manter o estado (ex: se o usuário está logado).</p>
<p><strong>Hashing</strong>: Processo de transformar uma entrada (como
uma senha) em uma string de tamanho fixo (o hash) usando um algoritmo. É
unidirecional, ou seja, não se pode obter a entrada original a partir do
hash.</p>
<p><strong>WSGI (Web Server Gateway Interface)</strong>: Uma
especificação padrão para a interface entre servidores web e aplicações
Python.</p>
<h2 id="conclusão"><strong>12. Conclusão</strong></h2>
<p>O projeto ProjectCare é uma aplicação web Flask bem estruturada e
abrangente, que aborda uma necessidade social importante: conectar
cuidadores de idosos a quem precisa desses serviços. A utilização de
tecnologias como Flask, SQLAlchemy, PostgreSQL, e Argon2 demonstra uma
base sólida e moderna. A organização do projeto em modelos, rotas,
serviços e templates segue boas práticas de desenvolvimento.</p>
<p>O README.md fornecido é excelente e já documenta grande parte do
projeto de forma clara. A análise do código revelou um sistema funcional
com muitos fluxos de usuário bem pensados.</p>
<p>Os pontos de atenção, especialmente a correção da falha de segurança
no login e o registro do user_bp, são cruciais. As demais sugestões de
melhoria, tanto as do README.md quanto as observadas durante a análise
do código, podem elevar ainda mais a qualidade, robustez e usabilidade
do ProjectCare.</p>
<p>Parabéns pelo desenvolvimento deste projeto! Ele tem um grande
potencial e uma base técnica muito boa para futuras expansões. Espero
que esta análise detalhada seja útil para o seu aprendizado e para os
próximos passos no desenvolvimento do ProjectCare.</p>
</body>
</html>
